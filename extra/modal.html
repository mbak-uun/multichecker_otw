<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MANAJEMEN ASSET</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.6.22/dist/css/uikit.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/893/893097.png" type="image/x-icon">
    <!-- Removed Bootstrap CSS and Bootstrap Icons; use UIkit icons instead -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="../js/notify-shim.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"
    integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="../idb-localstorage-shim.js"></script>
</head>
<style>
body {
    color: var(--text-primary);
    background: #f5f7fa;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    margin: 0;
    padding: 0;
}

.uk-container {
    max-width: 100%;
    padding: 10px;
    font-size: 13.5px;
}

/* Perbesar ukuran modal filter PNL */
#search-pnl-modal .uk-modal-dialog {
    max-width: none;   /* override default UIkit max-width */
    width: 90vw;       /* lebar responsif */
}
@media (min-width: 1200px) {
    #search-pnl-modal .uk-modal-dialog {
        width: 900px;  /* batas nyaman untuk layar lebar */
    }
}

.modal-title span {
    font-weight: 700;
    letter-spacing: 0.05em;
    color: #2c3e50;
}

.modal-title img {
    width: 32px;
    margin-left: 8px;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.15));
}

.uk-card.uk-card-default {
    padding: 16px;
    background: #ffffff;
    border: 1px solid #e1e8ed;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.modal-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 18px;
    flex-wrap: wrap;
}

.modal-toolbar .icon-boxes {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.modal-toolbar .icon-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

.modal-toolbar .icon-link img {
    width: 18px;
    height: 18px;
}

.modal-toolbar .icon-link:hover {
    background: #e9ecef;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.action-buttons {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
    flex-wrap: wrap;
}

.info-pills {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 12px;
    flex-wrap: wrap;
}

.info-pills span {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 600;
    color: #495057;
    font-size: 0.9rem;
}

.table-glass {
    width: 100%;
    border-collapse: collapse;
    border-radius: 8px;
    overflow: hidden;
    background: #ffffff;
    border: 1px solid #e1e8ed;
}

.table-glass thead th {
    background: #4a5568;
    color: #ffffff;
    font-weight: 600;
    letter-spacing: 0.03em;
    padding: 10px;
    text-align: center;
    text-transform: uppercase;
    font-size: 0.8rem;
}

.table-glass tbody td {
    padding: 8px 12px;
    color: #495057;
    border-bottom: 1px solid #f1f3f5;
    background: transparent;
    font-size: 0.85rem;
}

.table-glass tbody tr {
    transition: background 0.2s ease;
}

.table-glass tbody tr:hover {
    background: #f8f9fa;
}

.table-glass .table-total-row th {
    padding: 12px;
    text-align: center;
    font-size: 1rem;
    font-weight: 700;
    color: #2c3e50;
    background: #f8f9fa;
}

.cex-label {
    font-weight: 700;
    letter-spacing: 0.05em;
}

.chain-label {
    font-weight: 700;
    letter-spacing: 0.04em;
}

.input-group-text {
    background: #e9ecef;
    border: 1px solid #ced4da;
    color: #495057;
    font-weight: 600;
    font-size: 0.85rem;
}

.input-group .form-control {
    background: #ffffff;
    border: 1px solid #ced4da;
    color: #495057;
    font-size: 0.85rem;
}

.input-group .form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}


.asset-line {
    padding: 6px 0;
    border-bottom: 1px dashed rgba(31, 122, 77, 0.18);
    font-size: 13px;
}

.asset-line:last-of-type {
    border-bottom: none;
}

.error {
    background: rgba(255, 124, 152, 0.28);
    border-radius: var(--radius-sm);
}

img:hover {
    transform: scale(1.06);
    transition: transform 0.2s ease;
}

#calculator-modal .uk-modal-dialog {
    border-radius: var(--radius-lg);
    box-shadow: var(--glass-shadow);
}

#calculator-modal .uk-modal-body {
    padding: clamp(18px, 2vw, 28px);
    background: linear-gradient(160deg,#d5daee);
}

.uk-table td.uk-text-center,
.uk-table th.uk-text-center {
    text-align: center !important;
}

/* Enhanced Header Styles */
.main-header {
    background: #ffffff;
    padding: 16px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin-bottom: 16px;
    border: 1px solid #e1e8ed;
}

.header-description {
    font-size: 0.85rem;
    line-height: 1.5;
    max-width: 100%;
    margin: 6px auto 0;
    color: #6c757d;
}

/* Summary Cards Row */
.summary-cards {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.summary-card {
    background: #ffffff;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
    text-align: center;
}

.summary-card .card-title {
    font-size: 0.75rem;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.summary-card .card-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2c3e50;
    margin: 0;
}

.summary-card.positive .card-value {
    color: #28a745;
}

.summary-card.negative .card-value {
    color: #dc3545;
}

.summary-card .card-value-input-group {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 4px;
}

.summary-card .card-value-input-group .uk-input {
    flex: 1;
    min-width: 80px;
    text-align: right;
    font-size: 1.2rem;
    font-weight: 700;
    height: 38px;
    padding: 6px 8px;
}

/* Enhanced Card Section Headers */
.section-header {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 6px;
    margin-bottom: 12px;
    border-left: 3px solid #007bff;
}

.section-header h5 {
    margin: 0;
    font-weight: 600;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.95rem;
}

.section-header p {
    margin: 4px 0 0 0;
    font-size: 0.75rem;
    color: #6c757d;
}

/* Info Pills Horizontal Cards */
.info-pills-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.info-pill-card {
    background: #ffffff;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
}

.info-pill-card .pill-label {
    font-size: 0.7rem;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    display: block;
}

.info-pill-card .pill-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: #2c3e50;
    display: block;
}

.info-pill-card.positive .pill-value {
    color: #28a745;
}

.info-pill-card.negative .pill-value {
    color: #dc3545;
}

/* Exchange & Chain Input Groups Enhancement */
.input-group {
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 8px;
}

.input-group-text {
    min-width: 110px;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Enhanced Button Styling */
.uk-button {
    letter-spacing: 0.02em;
    transition: all 0.2s ease;
    border-radius: 6px;
    font-size: 0.8rem;
}

.uk-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.uk-button-primary {
    background: #007bff;
    color: #ffffff;
    border: none;
}

.uk-button-primary:hover {
    background: #0056b3;
}

.uk-button-secondary {
    background: #6c757d;
    color: #ffffff;
    border: none;
}

.uk-button-secondary:hover {
    background: #545b62;
}

.uk-button-danger {
    background: #dc3545;
    color: #ffffff;
    border: none;
}

.uk-button-danger:hover {
    background: #c82333;
}

/* Accordion Enhancement */
.uk-accordion-title {
    background: #4a5568;
    color: #ffffff;
    padding: 10px 12px;
    border-radius: 6px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
}
.uk-accordion-title span {
    color: #ffffff !important;
}
/* Hover/Active: ensure text color switches cleanly */
.uk-accordion-title:hover,
.uk-open > a.uk-accordion-title {
    background: #eff0f1;
    color: #1f2937;
}
.uk-accordion-title:hover span,
.uk-open > a.uk-accordion-title span {
    color: #1f2937 !important;
}
/* Enhanced Modal Capital Section */
.modal-capital-section {
    background: #ffffff;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #e1e8ed;
    margin-bottom: 16px;
}

.modal-capital-section label {
    color: #495057;
    font-size: 0.9rem;
    font-weight: 600;
}

/* Icon Styling */
.bi {
    vertical-align: middle;
    margin-right: 4px;
}

.section-header .bi,
.modal-title .bi {
    color: #007bff;
}

.info-pills .bi {
    color: #6c757d;
    font-size: 1em;
}

/* Enhanced Action Button Icons */
.uk-button .bi {
    margin-right: 4px;
    font-size: 1em;
}

/* Table Enhancements */
.table-glass tbody td {
    vertical-align: middle;
}

/* Calculator Modal Enhancements */
#calculator-modal .uk-form-label {
    font-weight: 600;
    color: #495057;
    min-width: 60px;
    display: inline-block;
}

#calculator-modal .uk-input {
    border: 1px solid #ced4da;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}

#calculator-modal .uk-input:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Smooth Transitions */
* {
    transition: background-color 0.2s ease, border-color 0.2s ease;
}

/* Loading State (optional for future use) */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Success/Error States */
.success-state {
    background: rgba(76, 175, 80, 0.15) !important;
    border-color: rgba(76, 175, 80, 0.4) !important;
}

.error-state {
    background: rgba(244, 67, 54, 0.15) !important;
    border-color: rgba(244, 67, 54, 0.4) !important;
}

/* Enhanced Checkbox Styling */
.uk-checkbox {
    width: 16px;
    height: 16px;
    border: 2px solid #ced4da;
    border-radius: 3px;
    cursor: pointer;
}

.uk-checkbox:checked {
    background-color: #007bff;
    border-color: #007bff;
}

/* Tooltip-like hover effects for icon links */
.modal-toolbar .icon-link {
    position: relative;
}

.modal-toolbar .icon-link:hover::after {
    content: attr(title);
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    white-space: nowrap;
    z-index: 1000;
}

/* Compact Layout for Iframe */
.uk-grid {
    margin: 0 !important;
}

.uk-grid > * {
    padding-left: 8px !important;
    padding-right: 8px !important;
}

.uk-margin-small-top {
    margin-top: 8px !important;
}

.uk-margin-small-bottom {
    margin-bottom: 8px !important;
}

/* Responsive Improvements */
@media (max-width: 1200px) {
    .summary-cards {
        grid-template-columns: repeat(2, 1fr);
    }

    .info-pills-cards {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }
}

@media (max-width: 768px) {
    .main-header {
        padding: 12px;
    }

    .header-description {
        font-size: 0.75rem;
    }

    .summary-cards {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }

    .info-pills-cards {
        grid-template-columns: 1fr;
        gap: 8px;
    }

    .section-header h5 {
        font-size: 0.85rem;
    }

    .section-header p {
        font-size: 0.7rem;
    }

    .modal-toolbar {
        flex-direction: column;
        gap: 10px;
    }

    .action-buttons {
        width: 100%;
        justify-content: center;
    }

    .uk-button {
        font-size: 0.75rem;
        padding: 6px 12px;
    }

    .table-glass {
        font-size: 0.75rem;
    }
}

@media (max-width: 640px) {
    .uk-grid > * {
        width: 100%;
    }

    .summary-cards {
        grid-template-columns: 1fr;
    }
}

/* ============================================ */
/* LOADING OVERLAY STYLES - BLACK & WHITE THEME */
/* ============================================ */
.balance-check-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease;
}

.balance-check-overlay.active {
    display: flex;
}

.overlay-content {
    background: linear-gradient(145deg, #1a1a1a 0%, #2d2d2d 100%);
    padding: 40px 50px;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 25px 70px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.1);
    max-width: 450px;
    animation: slideUp 0.4s ease;
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.overlay-spinner {
    width: 70px;
    height: 70px;
    margin: 0 auto 25px;
    border: 5px solid rgba(255, 255, 255, 0.1);
    border-top-color: #ffffff;
    border-right-color: rgba(255, 255, 255, 0.6);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.overlay-title {
    font-size: 24px;
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 12px;
    text-shadow: 0 2px 15px rgba(255, 255, 255, 0.1);
    letter-spacing: 0.5px;
}

.overlay-message {
    font-size: 15px;
    color: rgba(255, 255, 255, 0.75);
    margin-bottom: 20px;
    line-height: 1.6;
}

.overlay-progress {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50px;
    height: 8px;
    overflow: hidden;
    margin-top: 20px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
}

.overlay-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ffffff 0%, #e0e0e0 50%, #ffffff 100%);
    border-radius: 50px;
    transition: width 0.3s ease;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
    position: relative;
}

.overlay-progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.4) 50%,
        transparent 100%);
    animation: shimmer 1.5s infinite;
}

.overlay-details {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 15px;
    font-family: 'Courier New', monospace;
    letter-spacing: 0.5px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
</style>
<body>

<!-- ============================================ -->
<!-- LOADING OVERLAY FOR BALANCE CHECK -->
<!-- ============================================ -->
<div id="balanceCheckOverlay" class="balance-check-overlay">
    <div class="overlay-content">
        <div class="overlay-spinner"></div>
        <div class="overlay-title" id="overlayTitle">Memuat Saldo...</div>
        <div class="overlay-message" id="overlayMessage">Mohon tunggu, sedang mengambil data dari exchanger dan wallet...</div>
        <div class="overlay-progress">
            <div class="overlay-progress-bar" id="overlayProgressBar" style="width: 0%"></div>
        </div>
        <div class="overlay-details" id="overlayDetails"></div>
    </div>
</div>

<div class="uk-container uk-margin-small-top">
        <!-- Main Header with Description -->
        <div class="main-header uk-text-center">
            <h3 class="uk-margin-remove-bottom modal-title">
                <span>MANAJEMEN ASSET</span>
            </h3>
            <p class="header-description">
                Track aset crypto secara berkala di exchange & wallet dengan PNL monitoring
            </p>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="card-title  uk-text-primary"><span uk-icon="icon: database"></span> Total Saldo Exchanger</div>
                <div class="card-value" id="summaryTotalCEX">$0.00</div>
                <div class="card-value-idr uk-text-bold  uk-text-success" id="summaryTotalCEX_IDR">Rp 0</div>
            </div>
            <div class="summary-card">
                <div class="card-title uk-text-primary"><span uk-icon="icon: credit-card"></span> Total Saldo Wallet</div>
                <div class="card-value" id="summaryTotalWallet">$0.00</div>
                <div class="card-value-idr uk-text-bold  uk-text-success"  id="summaryTotalWallet_IDR">Rp 0</div>
            </div>
            <div class="summary-card">
                <div class="card-title uk-text-primary"><span uk-icon="icon: credit-card"></span> Total Semua Asset</div>
                <div class="card-value" id="summaryTotalAsset">$0.00</div>
                <div class="card-value-idr uk-text-bold  uk-text-success" id="summaryTotalAsset_IDR">Rp 0</div>
            </div>
            <div class="summary-card" id="summaryPNLCard">
                <div class="card-title uk-text-primary"><span uk-icon="icon: arrow-up"></span> Profit & Lost</div>
                <div class="card-value" id="summaryPNL">$0.00</div>
                <div class="card-value-idr uk-text-bold" id="summaryPNL_IDR">Rp 0</div>
            </div>
            <div class="summary-card">
                <div class="card-title uk-text-primary"><span uk-icon="icon: credit-card"></span> Modal Awal (USDT)</div>
                <div class="card-value-input-group">
                    <input type="number" class="uk-input" id="MODALAWAL" placeholder="Modal Awal" value="1.00" step="0.01" required />
                    <button class="uk-button uk-button-small uk-button-primary" id="SaveModal" title="Simpan Modal"><span uk-icon="icon: check"></span> SIMPAN</button>
                </div>
                <div class="card-value-idr uk-text-bold uk-text-primary" id="RPMODAL" >Rp 0</div>
            </div>
        </div>

    <!-- Grid Container -->
    <div class="uk-grid uk-child-width-1-1@s uk-child-width-1-2@m uk-child-width-1-3@l uk-grid-small" uk-grid>
        <div>
            <div class="uk-card uk-card-default uk-card-body">
            

                <!-- Container Accordion -->
                <ul uk-accordion="multiple: true">
                    <!-- Collapse: Setting All Exchanges -->
                    <li class="uk-open">
                        <a class="uk-accordion-title" href="#">
                            <h5 class="uk-heading-line uk-text-primary uk-margin-remove"><span><span uk-icon="icon: database"></span> Centralized Exchanges (CEX)</span></h5>
                        </a>
                        <div class="uk-accordion-content">
                                <p class="uk-text-small uk-text-muted uk-margin-small-bottom"><span uk-icon="icon: info"></span> Centang exchange yang aktif dan masukkan API Key</p>
                                <div class="input-group uk-margin-small">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            <input type="checkbox" class="uk-checkbox"  checked id="BINANCE" />&nbsp;
                                            <label class="form-check-label text-cex-binance" for="BINANCE">BINANCE</label>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control uk-input uk-form-small" id="apikeyBINANCE" placeholder="API KEY BINANCE" value="" required />
                                    <input type="text" class="form-control uk-input uk-form-small" id="secretkeyBINANCE" placeholder="SECRET KEY BINANCE" value="" required />
                                </div>

                                <div class="input-group uk-margin-small">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            <input type="checkbox" class="uk-checkbox" id="GATE" />&nbsp;
                                            <label class="form-check-label text-cex-gate" for="GATE">GATE</label>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control uk-input uk-form-small" id="apikeyGATE" placeholder="API KEY GATE" value="" required />
                                    <input type="text" class="form-control uk-input uk-form-small" id="secretkeyGATE" placeholder="SECRET KEY GATE" value="" required />
                                </div>
                                
                                <div class="input-group uk-margin-small">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            <input type="checkbox" class="uk-checkbox"  id="BITGET" />&nbsp;
                                            <label class="form-check-label text-cex-bitget" for="BITGET">BITGET</label>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control uk-input uk-form-small" id="apikeyBITGET" placeholder="API KEY BITGET" value="" required />
                                    <input type="text" class="form-control uk-input uk-form-small" id="secretkeyBITGET" placeholder="SECRET KEY BITGET" value="" required />
                                    <input type="text" class="form-control uk-input uk-form-small" id="passphraseBITGET" placeholder="PASSPHRASE KEY BITGET" value="" required />
                                </div>

                                <div class="input-group uk-margin-small">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            <input type="checkbox" class="uk-checkbox"  id="KUCOIN" />&nbsp;
                                            <label class="form-check-label text-cex-kucoin" for="KUCOIN">KUCOIN</label>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control uk-input uk-form-small" id="apikeyKUCOIN" placeholder="API KEY KUCOIN" value="" required />
                                    <input type="text" class="form-control uk-input uk-form-small" id="secretkeyKUCOIN" placeholder="SECRET KEY KUCOIN" value="" required />
                                    <input type="text" class="form-control uk-input uk-form-small" id="passphraseKUCOIN" placeholder="PASSPHRASE KEY KUCOIN" value="" required />
                                </div>

                                <div class="input-group uk-margin-small">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            <input type="checkbox" class="uk-checkbox" id="BYBIT" />&nbsp;
                                            <label class="form-check-label text-cex-bybit" for="BYBIT">BYBIT</label>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control uk-input uk-form-small" id="apikeyBYBIT" placeholder="API KEY BYBIT" value="" required />
                                    <input type="text" class="form-control uk-input uk-form-small" id="secretkeyBYBIT" placeholder="SECRET KEY BYBIT" value="" required />
                                </div>

                                <div class="input-group uk-margin-small">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            <input type="checkbox" class="uk-checkbox" id="INDODAX" />&nbsp;
                                            <label class="form-check-label text-cex-indodax" for="INDODAX">INDODAX</label>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control uk-input uk-form-small" id="apikeyINDODAX" placeholder="API KEY INDODAX" value="" required />
                                    <input type="text" class="form-control uk-input uk-form-small" id="secretkeyINDODAX" placeholder="SECRET KEY INDODAX" value="" required />
                                </div>

                                <div class="input-group uk-margin-small">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            <input type="checkbox" class="uk-checkbox" id="MEXC" />&nbsp;
                                            <label class="form-check-label text-cex-mexc" for="MEXC">MEXC</label>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control uk-input uk-form-small" id="apikeyMEXC" placeholder="API KEY MEXC" value="" required />
                                    <input type="text" class="form-control uk-input uk-form-small" id="secretkeyMEXC" placeholder="SECRET KEY MEXC" value="" required />
                                </div>

                                <div class="uk-flex uk-flex-right uk-margin-small-top">
                                    <button class="uk-button uk-button-small uk-button-primary" id="SaveConfigCEXS"><span uk-icon="icon: check"></span> CHECK EXCHANGER</button>
                                </div>
                        </div>
                    </li>

                    <!-- Collapse: Setting Chains & Wallet -->
                    <li class="uk-open">
                        <a class="uk-accordion-title" href="#">
                            <h5 class="uk-heading-line uk-text-left uk-margin-remove"><span><span uk-icon="icon: credit-card"></span> Blockchain Wallets</span></h5>
                        </a>
                        <div class="uk-accordion-content">
                                <p class="uk-text-small uk-text-muted uk-margin-small-bottom"><span uk-icon="icon: info"></span> Centang chain yang aktif dan masukkan wallet address</p>
                            <div class="input-group uk-margin-small">
                                        <div class="input-group-prepend">
                                            <div class="input-group-text">
                                                <input type="checkbox"  id="ETHEREUM" />&nbsp;
                                                <label class="form-check-label text-chain-ethereum" for="ethWallet">ETHEREUM</label>
                                            </div>
                                        </div>
                                        <input class="form-control uk-input uk-form-small" type="text" id="ethWallet" placeholder="Enter Ethereum Wallet Address">
                                    </div>

                                    <div class="input-group uk-margin-small">
                                        <div class="input-group-prepend">
                                            <div class="input-group-text">
                                                <input type="checkbox"  id="BSC" />&nbsp;
                                                <label class="form-check-label text-chain-bsc" for="bscWallet">BSC</label>
                                            </div>
                                        </div>
                                        <input class="form-control uk-input uk-form-small" type="text" id="bscWallet" placeholder="Enter BSC Wallet Address">
                                    </div>

                                    <div class="input-group uk-margin-small">
                                        <div class="input-group-prepend">
                                            <div class="input-group-text">
                                                <input type="checkbox"  id="POLYGON" />&nbsp;
                                                <label class="form-check-label text-chain-polygon" for="polygonWallet">POLYGON</label>
                                            </div>
                                        </div>
                                        <input class="form-control uk-input uk-form-small" type="text" id="polygonWallet" placeholder="Enter Polygon Wallet Address">
                                    </div>

                                    <div class="input-group uk-margin-small">
                                        <div class="input-group-prepend">
                                            <div class="input-group-text">
                                                <input type="checkbox"  id="BASE" />&nbsp;
                                                <label class="form-check-label text-chain-base" for="baseWallet">BASE</label>
                                            </div>
                                        </div>
                                        <input class="form-control uk-input uk-form-small" type="text" id="baseWallet" placeholder="Enter Base Wallet Address">
                                    </div>

                                    <div class="input-group uk-margin-small" >
                                        <div class="input-group-prepend">
                                            <div class="input-group-text">
                                                <input type="checkbox"  id="ARBITRUM" />&nbsp;
                                                <label class="form-check-label text-chain-arbitrum" for="arbitrumWallet">ARBITRUM</label>
                                            </div>
                                        </div>
                                        <input class="form-control uk-input uk-form-small" type="text" id="arbitrumWallet" placeholder="Enter Arbitrum Wallet Address">
                                    </div>
                                    <!-- <div class="input-group mb-2">
                                        <div class="input-group-prepend">
                                            <div class="input-group-text">
                                                <input type="checkbox"  id="AVAX" />&nbsp;
                                                <label class="form-check-label" for="avaxWallet">AVAX</label>
                                            </div>
                                        </div>
                                        <input class="form-control uk-input uk-form-small" type="text" id="avaxWallet" placeholder="Enter AVAX Wallet Address">
                                    </div>
                                    <div class="input-group mb-2">
                                        <div class="input-group-prepend">
                                            <div class="input-group-text">
                                                <input type="checkbox"  id="SOLANA" />&nbsp;
                                                <label class="form-check-label" for="solanaWallet">SOLANA</label>
                                            </div>
                                        </div>
                                        <input class="form-control uk-input uk-form-small" type="text" id="solanaWallet" placeholder="Enter Solana Wallet Address">
                                    </div> -->
                                    
                                    <div class="uk-flex uk-flex-right uk-margin-small-top">
                                        <button class="uk-button uk-button-small uk-button-secondary" id="SaveWalletChains"><span uk-icon="icon: check"></span> CHECK WALLETS</button>
                                    </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <!-- Kolom 2 -->
         <div>
            <div class="uk-card uk-card-default uk-card-body">
                
                <!-- Action Buttons -->
                <div class="modal-toolbar">
                    <div class="action-buttons" style="width: 100%; justify-content: space-between;">
                        <div class="icon-boxes">
                            <a class="icon-link" href="/extra/modal.html" target="_blank" rel="noopener noreferrer" title="Buka di tab baru">
                                <img src="https://cdn-icons-png.flaticon.com/512/5548/5548820.png" alt="Tab baru">
                            </a>
                            <a class="icon-link" href="#" id="reload" title="Muat ulang halaman">
                                <img src="https://cdn-icons-png.freepik.com/512/210/210136.png" alt="Reload">
                            </a>
                            <a class="icon-link" href="#" id="openModalKalkulator" title="Kalkulator Crypto">
                                <img src="https://cdn-icons-png.flaticon.com/512/342/342344.png" alt="Kalkulator">
                            </a>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="uk-button uk-button-small uk-button-primary" id="CheckModal"><span uk-icon="icon: refresh"></span> Check</button>
                            <button class="uk-button uk-button-small uk-button-danger" id="ResetModal"><span uk-icon="icon: close"></span> Reset</button>
                        </div>
                    </div>
                </div>

                <!-- Info Pills as Cards -->
                <div class="info-pills-cards uk-margin-small-top">
                    <div class="info-pill-card">
                        <span class="pill-label uk-text-success">Modal Awal</span>
                        <strong class="pill-value" id="m_awal">...</strong>
                    </div>
                    <div class="info-pill-card">
                        <span class="pill-label   uk-text-primary">Modal Akhir</span>
                        <strong class="pill-value" id="m_akhir">...</strong>
                    </div>
                    <div class="info-pill-card" id="pnlCard">
                        <span class="pill-label">PNL</span>
                        <strong class="pill-value" id="m_pnl">...</strong>
                    </div>
                </div>
                <table class="uk-table uk-table-striped uk-table-hover uk-margin-top table-glass" id="assetTableCexs">
                    <thead>
                        <tr>
                            <th>Exchanger</th>
                            <th>Saldo &amp; Rate USDT ($)</th>
                        </tr>
                    </thead>
                    <tbody class="cex-static">
                        <tr data-cex="BINANCE">
                            <td class="uk-text-left cex-label text-cex-binance">BINANCE</td>
                            <td id="BINANCESaldo" class="uk-text-right">xxx {USDT}</td>
                        </tr>
                        <tr data-cex="GATE">
                            <td class="uk-text-left cex-label text-cex-gate">GATE</td>
                            <td id="GATESaldo" class="uk-text-right">xxx {USDT}</td>
                        </tr>
                        <tr data-cex="BITGET">
                            <td class="uk-text-left cex-label text-cex-bitget">BITGET</td>
                            <td id="BITGETSaldo" class="uk-text-right">xxx {USDT}</td>
                        </tr>
                        <tr data-cex="KUCOIN">
                            <td class="uk-text-left cex-label text-cex-kucoin">KUCOIN</td>
                            <td id="KUCOINSaldo" class="uk-text-right">xxx {USDT}</td>
                        </tr>
                        <tr data-cex="BYBIT">
                            <td class="uk-text-left cex-label text-cex-bybit">BYBIT</td>
                            <td id="BYBITSaldo" class="uk-text-right">xxx {USDT}</td>
                        </tr>
                        <tr data-cex="INDODAX">
                            <td class="uk-text-left cex-label text-cex-indodax">INDODAX</td>
                            <td id="INDODAXSaldo" class="uk-text-right">xxx {INDODAX}</td>
                        </tr>
                        <tr data-cex="MEXC">
                            <td class="uk-text-left cex-label text-cex-mexc">MEXC</td>
                            <td id="MEXCSaldo" class="uk-text-right">xxx {USDT}</td>
                        </tr>
                    </tbody>
                    <tbody id="output_cex"></tbody>
                    <tfoot>
                        <tr class="table-total-row">
                            <th id="LTotalSaldoCEX">TOTAL</th>
                            <th id="TotalSaldoCEX">...</th>
                        </tr>
                    </tfoot>
                </table>
                <table class="uk-table uk-table-striped uk-table-hover uk-margin-top table-glass" id="assetTableWallet" style="display:none;">
                    <thead>
                        <tr>
                            <th>Chain</th>
                            <th>Asset</th>
                            <th>Fee Gas [USDT]</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="output_chain"></tbody>
                    <tfoot>
                        <tr class="table-total-row">
                            <th colspan="2" id="LTotalSaldoWallets">Total</th>
                            <th colspan="2" id="TotalSaldoWallets">...</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <!-- Kolom 3 -->
        <div>
            <div class="uk-card uk-card-default uk-card-body">
               

                <!-- Status Info -->
                <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 12px 0; font-size: 0.85rem;">
                    <div class="uk-text-danger" style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span class="  uk-text-bold">Last Check:</span>
                        <strong id="lastUpdate">...</strong>
                    </div>
                    <div class="uk-text-secondary" style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span class="  uk-text-bold" >Modal Saat Ini:</span>
                        <strong id="m_akhirs">...</strong>
                    </div>
                    <div id="pnl-container" style="display: flex; justify-content: space-between;">
                        <span class="  uk-text-bold">PNL Saat Ini:</span>
                        <strong id="m_pnls">...</strong>
                    </div>
                </div>

                <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-small-bottom">
                    <h6 style="margin: 0; font-weight: 600; color: #495057;">
                        <span uk-icon="icon: history"></span> History Modal
                    </h6>
                    <div style="display: flex; gap: 8px;">
                        <button class="uk-button uk-button-small uk-button-secondary" id="SearchHistoryPNL" title="Filter Pencarian"><span uk-icon="icon: search"></span></button>
                        <button class="uk-button uk-button-small uk-button-primary" id="UpdateHistoryPNL"><span uk-icon="icon: refresh"></span> Update</button>
                    </div>
                </div>
                       
                       <!-- Modal Kalkulator -->
                        <div id="calculator-modal" uk-modal >
                            <div class="uk-modal-dialog uk-modal-body uk-width-large uk-padding-remove-bottom">
                                <button class="uk-modal-close-default" type="button" uk-close></button>

                                <h3 class="uk-heading-divider uk-align-center uk-text-primary uk-margin-small-bottom">
                                    <span uk-icon="icon: cog"></span> KALKULATOR CRYPTO
                                </h3>
                                <p class="uk-text-center k-text-small uk-text-primary uk-margin-remove-top">
                                    <span uk-icon="icon: info"></span> Konversi Harga Crypto Secara Realtime
                                </p>
                                    <!-- Input Fields for Cryptocurrency Values -->
                                    <div class="uk-grid-small uk-child-width-1-1 uk-align-center uk-margin-remove uk-padding-remove" uk-grid>
                                        <div class="uk-margin-small-top">
                                            <div class="uk-form-controls">
                                                <label for="usdtprice" class="uk-form-label uk-margin-large-right"><b>USDT </b></label>
                                                <input id="usdtprice" class="uk-input dynamic-input uk-form-width-large" type="text" placeholder="Masukkan nilai USDT" oninput="convertFromInput('usdt')">
                                            </div>
                                        </div>
                                        <div class="uk-margin-small-top">
                                            <div class="uk-form-controls">
                                                <label for="idrprice" class="uk-form-label uk-margin-large-right"><b>IDR&nbsp;&nbsp;</b></label>
                                                <input id="idrprice" class="uk-input dynamic-input uk-form-width-large" type="text" placeholder="Masukkan nilai IDR" oninput="convertFromInput('idr')">
                                            </div>
                                        </div>
                                        <div class="uk-margin-small-top">
                                            <div class="uk-form-controls">
                                                <label for="btcprice" class="uk-form-label uk-margin-large-right"><b>BTC&nbsp;&nbsp;</b></label>
                                                <input id="btcprice" class="uk-input dynamic-input uk-form-width-large" type="text" placeholder="Masukkan nilai BTC" oninput="convertFromInput('btc')">
                                            </div>
                                        </div>
                                        <div class="uk-margin-small-top">
                                            <div class="uk-form-controls">
                                                <label for="ethprice" class="uk-form-label uk-margin-large-right"><b>ETH&nbsp;&nbsp;</b></label>
                                                <input id="ethprice" class="uk-input dynamic-input uk-form-width-large" type="text" placeholder="Masukkan nilai ETH" oninput="convertFromInput('eth')">
                                            </div>
                                        </div>
                                        <div class="uk-margin-small-top">
                                            <div class="uk-form-controls">
                                                <label for="bnbprice" class="uk-form-label uk-margin-large-right"><b>BNB&nbsp;&nbsp;</b></label>
                                                <input id="bnbprice" class="uk-input dynamic-input uk-form-width-large" type="text" placeholder="Masukkan nilai BNB" oninput="convertFromInput('bnb')">
                                            </div>
                                        </div>
                                            <!-- Input untuk Token 1 -->
                                            <div class="uk-margin-small-top">                    
                                                <div class="uk-form-controls">
                                                    <label for="random1symbol" class="uk-form-label uk-text-danger"><b>CUSTOM TOKEN :</b></label>
                                                    <div class="uk-button-group ">
                                                        <input type="text" class="uk-input dynamic-input uk-form-width-medium" id="random1symbol" placeholder="Symbol TOKEN">
                                                        <input type="text" class="uk-input dynamic-input" id="random1price" placeholder="Harga TOKEN" disabled>
                                                    </div>
                                                </div>
                                            </div>
                                        
                                            <div class="uk-form-controls  uk-align-center">
                                                <div class="uk-button-group  uk-form-width-large">
                                                    <button class="uk-button uk-button-small uk-button-danger uk-margin-large-left" id="cekTokensBtn">CEK Tokens</button>
                                                    <button class="uk-button uk-button-small uk-button-primary" id="updatePriceBtn">Update Price</button>
                                                </div>
                                            </div>
                                        <div>

                                        </div>
                                    </div>
                            </div>
                        </div>

                        <!-- Modal Filter Pencarian PNL -->
                        <div id="search-pnl-modal" uk-modal>
                            <div class="uk-modal-dialog uk-modal-body uk-width-large">
                                <button class="uk-modal-close-default" type="button" uk-close></button>

                                <h3 class="uk-heading-divider uk-align-center uk-text-primary uk-margin-small-bottom">
                                    <span uk-icon="icon: search"></span> REKAP PNL BERDASARKAN TANGGAL
                                </h3>
                                <p class="uk-text-center uk-text-small uk-text-primary uk-margin-remove-top">
                                    <span uk-icon="icon: calendar"></span> Pilih Rentang Tanggal untuk Melihat Rekap PNL Harian
                                </p>

                                <!-- Filter Form (sejajar) -->
                                <div class="uk-grid-small uk-flex-middle uk-child-width-auto uk-margin-small-top" uk-grid>
                                    <div>
                                        <label class="uk-form-label uk-text-bold" for="startDate">Tanggal Mulai</label>
                                        <input class="uk-input" type="date" id="startDate" placeholder="Pilih tanggal mulai">
                                    </div>
                                    <div>
                                        <label class="uk-form-label uk-text-bold" for="endDate">Tanggal Akhir</label>
                                        <input class="uk-input" type="date" id="endDate" placeholder="Pilih tanggal akhir">
                                    </div>
                                    <div>
                                        <button class="uk-button uk-button-primary" id="applyFilterPNL">
                                            <span uk-icon="icon: check"></span> Tampilkan
                                        </button>
                                    </div>
                                    <div>
                                        <button class="uk-button uk-button-secondary" id="resetFilterPNL">
                                            <span uk-icon="icon: refresh"></span> Reset
                                        </button>
                                    </div>
                                </div>

                                <!-- Hasil Rekap -->
                                <div id="rekapPNLContainer" class="uk-margin-top" style="display: none;">
                                    <hr class="uk-divider-icon">
                                
                                    <!-- Ringkasan card dihilangkan sesuai permintaan -->

                                    <!-- Table Rekap -->
                                    <div class="uk-overflow-auto uk-margin-small-top">
                                        <table class="uk-table uk-table-striped uk-table-hover table-glass">
                                            <thead>
                                                <tr>
                                                    <th>Tanggal</th>
                                                    <th>Modal Awal</th>
                                                    <th>Modal Akhir</th>
                                                    <th>PNL</th>
                                                    <th>% Change</th>
                                                </tr>
                                            </thead>
                                            <tbody id="rekapPNLTableBody">
                                                <tr class="uk-text-center uk-text-muted">
                                                    <td colspan="5">Belum ada data</td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr class="table-total-row">
                                                    <th>TOTAL</th>
                                                    <th id="footerModalAwal">$0.00</th>
                                                    <th id="footerModalAkhir">$0.00</th>
                                                    <th id="footerPNL">$0.00</th>
                                                    <th id="footerPercentage">0%</th>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        

                        <div class="uk-overflow-auto uk-margin-small-top">
                            <table class="uk-table uk-table-striped uk-table-hover table-glass" id="assetTablePNL">
                                <thead>
                                    <tr>
                                        <th>Time Update</th>
                                        <th>Modal Awal</th>
                                        <th>Modal Akhir</th>
                                        <th>PNL</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="uk-text-center uk-text-muted">
                                        <td colspan="5">Belum ada data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="pnl-pagination" class="uk-flex uk-flex-between uk-margin-small-top">
                            <button id="pnlPrev" class="uk-button uk-button-small uk-button-secondary">&lt;&lt;prev</button>
                            <span id="pnlPageInfo" class="uk-text-meta">Halaman 1/1</span>
                            <button id="pnlNext" class="uk-button uk-button-small uk-button-secondary">next&gt;&gt;</button>
                        </div>
                                       
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(async function () {
        // Ensure IndexedDB-backed localStorage is initialized
        if (window.__IDB_LOCALSTORAGE_READY__) {
            try { await window.__IDB_LOCALSTORAGE_READY__; } catch (e) {}
        }

        // Paging state for PNL history
        let pnlCurrentPage = 0;
        const PNL_PAGE_SIZE = 10; // jumlah item per halaman

        // ============================================
        // LOADING OVERLAY CONTROLLER
        // ============================================
        window.BalanceCheckOverlay = {
            isActive: false,

            show: function(title = "Memuat Saldo...", message = "Mohon tunggu...") {
                this.isActive = true;
                $('#balanceCheckOverlay').addClass('active');
                $('#overlayTitle').text(title);
                $('#overlayMessage').text(message);
                $('#overlayProgressBar').css('width', '0%');
                $('#overlayDetails').text('');
            },

            hide: function() {
                this.isActive = false;
                $('#balanceCheckOverlay').removeClass('active');
                $('#overlayProgressBar').css('width', '0%');
            },

            updateProgress: function(percent, details = '') {
                if (!this.isActive) return; // Don't update if not active
                $('#overlayProgressBar').css('width', percent + '%');
                if (details) {
                    $('#overlayDetails').text(details);
                }
            },

            updateMessage: function(title, message) {
                if (!this.isActive) return; // Don't update if not active
                $('#overlayTitle').text(title);
                $('#overlayMessage').text(message);
            }
        };

        // Helpers to wait until tables are actually populated before hiding overlay
        async function waitFor(conditionFn, timeoutMs = 15000, intervalMs = 100) {
            const start = Date.now();
            return new Promise((resolve) => {
                const timer = setInterval(() => {
                    if (conditionFn()) {
                        clearInterval(timer);
                        resolve(true);
                    } else if (Date.now() - start > timeoutMs) {
                        clearInterval(timer);
                        resolve(false);
                    }
                }, intervalMs);
            });
        }

        function isCexTableReady() {
            // Ensure no placeholder values remain on visible rows and total is computed
            const hasPlaceholders = $("#assetTableCexs tbody.cex-static tr:visible td[id$='Saldo']")
                .toArray()
                .some(td => /xxx|\?\?\?/.test($(td).text()));
            const totalText = $('#TotalSaldoCEX').text().trim();
            const totalReady = totalText !== '...' && totalText.length > 0;
            return !hasPlaceholders && totalReady;
        }

        function isWalletTableReady(expectedResults) {
            const rowsCount = $('#output_chain tr').length;
            const expected = Array.isArray(expectedResults)
                ? expectedResults.filter(r => !r.error).length
                : rowsCount; // fallback
            const totalReady = $('#TotalSaldoWallets').text().trim() !== '...';
            return rowsCount >= expected && expected > 0 && totalReady;
        }

        // KALKULATOR 
            var ratePrice = {
                usdt: 1,
                idr: 0,
                btc: 0,
                eth: 0,
                bnb: 0,
                random1: 0 // Custom token rate
            };
            // Fungsi untuk memformat IDR dengan pemisah ribuan
            // function formatIDR(value) {
            //    // return new Intl.NumberFormat('id-ID').format(value); // 'id-ID' untuk format Indonesia
            //     return new Intl.NumberFormat('id-ID').format(Math.floor(value));
            // }
   
            function formatIDR(value) {
                return new Intl.NumberFormat('id-ID', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value);
            }

            // Fungsi untuk memperbarui harga semua token, termasuk custom token
            $("#updatePriceBtn").on("click", function() {
                // Memperbarui harga untuk token yang sudah didefinisikan (seperti BTC, ETH, dll.)
                fetchRates();

                // Ambil simbol token custom dari input
                var symbol1 = $("#random1symbol").val().toUpperCase().trim();
                if (symbol1) {
                    // Jika simbol token custom ada, coba untuk mengambil harga terbaru
                    $.getJSON("https://api-gcp.binance.com/api/v3/ticker/price?symbol=" + symbol1 + "USDT")
                        .done(function(response) {
                            // Memperbarui harga custom token
                            ratePrice.random1 = parseFloat(response.price);
                            $("#random1price").prop("disabled", false).val(ratePrice.random1.toFixed(8));
                            if (typeof toast !== 'undefined' && toast.info) toast.info("Custom token " + symbol1 + " ditemukan dengan harga " + ratePrice.random1 + " USDT.");
                        })
                        .fail(function() {
                            if (typeof toast !== 'undefined' && toast.error) toast.error("Custom token tidak ditemukan.");
                            ratePrice.random1 = 0;
                            $("#random1price").prop("disabled", true).val('');
                        });
                }

                if (typeof toast !== 'undefined' && toast.info) toast.info("Harga token telah diperbarui!");
            });

            // Fetch initial rates
            function fetchRatesx() {
                const binanceURL = encodeURIComponent('https://data-api.binance.vision/api/v3/ticker/price?symbols=["BTCUSDT","ETHUSDT","BNBUSDT","POLUSDT","AVAXUSDT","SOLUSDT"]');
                const indodaxURL = encodeURIComponent('https://cors-proxy-rosy.vercel.app/api/proxy?url=https://indodax.com/api/ticker/usdtidr');

                $.when(
                    $.ajax({
                        url: `https://api.allorigins.win/get?url=${binanceURL}`,
                        method: 'GET',
                        dataType: 'json'
                    }),
                    $.ajax({
                        url: `https://api.allorigins.win/get?url=${indodaxURL}`,
                        method: 'GET',
                        dataType: 'json'
                    })
                ).done(function (binanceResponse, indodaxResponse) {
                    const binanceData = JSON.parse(binanceResponse.contents);
                    const indodaxData = JSON.parse(indodaxResponse.contents);

                    binanceData.forEach((res) => {
                        switch (res.symbol) {
                            case "BTCUSDT": ratePrice.btc = parseFloat(res.price); break;
                            case "ETHUSDT": ratePrice.eth = parseFloat(res.price); break;
                            case "BNBUSDT": ratePrice.bnb = parseFloat(res.price); break;
                            case "POLUSDT": ratePrice.pol = parseFloat(res.price); break;
                            case "AVAXUSDT": ratePrice.avax = parseFloat(res.price); break;
                            case "SOLUSDT": ratePrice.sol = parseFloat(res.price); break;
                        }
                    });

                    ratePrice.idr = parseFloat(indodaxData.ticker.last);
                    console.log('âœ… ratePrice:', ratePrice);
                }).fail(function (error) {
                    console.warn('âŒ Failed to fetch rates:', error);
                });
            }

            function fetchRates() {
                $.when(
                    $.getJSON("https://api-gcp.binance.com/api/v3/ticker/price?symbols=[%22BTCUSDT%22,%22ETHUSDT%22,%22BNBUSDT%22,%22POLUSDT%22,%22AVAXUSDT%22,%22SOLUSDT%22]"),
                    $.getJSON("https://cors-proxy-rosy.vercel.app/api/proxy?url=https://indodax.com/api/ticker/USDTIDR")
                ).done(function (binanceResponse, indodaxResponse) {
                    binanceResponse[0].forEach((res) => {
                        switch (res.symbol) {
                            case "BTCUSDT": ratePrice.btc = parseFloat(res.price); break;
                            case "ETHUSDT": ratePrice.eth = parseFloat(res.price); break;
                            case "BNBUSDT": ratePrice.bnb = parseFloat(res.price); break;
                            case "POLUSDT": ratePrice.pol = parseFloat(res.price); break;
                            case "AVAXUSDT": ratePrice.avax = parseFloat(res.price); break;
                            case "SOLUSDT": ratePrice.sol = parseFloat(res.price); break;
                        }
                    });
                    ratePrice.idr = parseFloat(indodaxResponse[0].ticker.last);
                }).fail(function (error) {
                    console.log("-----------------------");
                    console.log(error);
                });
            }

        const stableCoinRates = {
            USDT: 1,
            USDC: 1,
            BUSD: 1,
            TUSD: 1,
            USDP: 1,
            FDUSD: 1,
            DAI: 1
        };

        const MIN_DISPLAY_USDT = 0.5;

        const priceTickerCache = {
            lastFetch: 0,
            tickers: new Map(),
            assetRates: new Map()
        };

        const pendingRateLookups = new Set();

        function escapeHtml(value) {
            if (typeof value !== "string") return value;
            return value.replace(/[&<>"']/g, function (char) {
                const map = {
                    "&": "&amp;",
                    "<": "&lt;",
                    ">": "&gt;",
                    '"': "&quot;",
                    "'": "&#039;"
                };
                return map[char] || char;
            });
        }

        function formatTokenAmount(amount) {
            if (!isFinite(amount)) return "0";
            const absValue = Math.abs(amount);
            if (absValue >= 1000) return amount.toLocaleString("en-US", { maximumFractionDigits: 2 });
            if (absValue >= 1) return amount.toLocaleString("en-US", { maximumFractionDigits: 2 });
            if (absValue >= 0.01) return amount.toFixed(4);
            return amount.toFixed(6);
        }

        function formatUsdtValue(value) {
            if (!isFinite(value)) return "0.00";
            return value.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        // Expose formatter for usage outside this closure (legacy handlers)
        window.formatUsdtValue = formatUsdtValue;

        function formatRate(value) {
            if (!isFinite(value) || value <= 0) return "N/A";
            const absValue = Math.abs(value);
            if (absValue >= 1000) return value.toLocaleString("en-US", { maximumFractionDigits: 2 });
            if (absValue >= 1) return value.toFixed(4);
            return value.toFixed(6);
        }

        async function ensureTickerCache() {
            if (priceTickerCache.tickers.size && (Date.now() - priceTickerCache.lastFetch) < 60000) {
                return priceTickerCache.tickers;
            }
            try {
                const response = await fetch("https://data-api.binance.vision/api/v3/ticker/price");
                if (!response.ok) throw new Error(`Ticker request failed: ${response.status}`);
                const data = await response.json();
                const map = new Map();
                data.forEach(item => {
                    if (item?.symbol && item?.price) {
                        map.set(item.symbol.toUpperCase(), parseFloat(item.price));
                    }
                });
                priceTickerCache.tickers = map;
                priceTickerCache.lastFetch = Date.now();
                priceTickerCache.assetRates.clear();
            } catch (error) {
                console.warn("âŒ Failed to refresh Binance ticker cache", error);
                if (!priceTickerCache.tickers.size) {
                    throw error;
                }
            }
            return priceTickerCache.tickers;
        }

        async function getUsdtRate(symbol) {
            const upper = (symbol || "").toUpperCase();
            if (!upper) return 0;

            if (stableCoinRates[upper] !== undefined) {
                priceTickerCache.assetRates.set(upper, stableCoinRates[upper]);
                return stableCoinRates[upper];
            }

            if (priceTickerCache.assetRates.has(upper)) {
                return priceTickerCache.assetRates.get(upper);
            }

            if (pendingRateLookups.has(upper)) {
                return priceTickerCache.assetRates.get(upper) || 0;
            }

            pendingRateLookups.add(upper);
            let resolvedRate = 0;

            try {
                const tickers = await ensureTickerCache();

                const directPair = tickers.get(`${upper}USDT`);
                if (directPair) {
                    resolvedRate = parseFloat(directPair);
                } else {
                    const inversePair = tickers.get(`USDT${upper}`);
                    if (inversePair) {
                        resolvedRate = 1 / parseFloat(inversePair);
                    }
                }

                if (!resolvedRate) {
                    const altStableCoins = Object.keys(stableCoinRates).filter(stable => stable !== "USDT");
                    for (const stable of altStableCoins) {
                        const directAlt = tickers.get(`${upper}${stable}`);
                        if (directAlt) {
                            resolvedRate = parseFloat(directAlt) * stableCoinRates[stable];
                            break;
                        }
                        const inverseAlt = tickers.get(`${stable}${upper}`);
                        if (inverseAlt) {
                            resolvedRate = stableCoinRates[stable] / parseFloat(inverseAlt);
                            break;
                        }
                    }
                }

                if (!resolvedRate) {
                    for (const [pair, price] of tickers.entries()) {
                        if (pair.startsWith(upper)) {
                            const quote = pair.slice(upper.length);
                            if (quote && quote !== upper) {
                                const quoteRate = await getUsdtRate(quote);
                                if (quoteRate) {
                                    resolvedRate = parseFloat(price) * quoteRate;
                                    break;
                                }
                            }
                        } else if (pair.endsWith(upper)) {
                            const base = pair.slice(0, pair.length - upper.length);
                            if (base && base !== upper) {
                                const baseRate = await getUsdtRate(base);
                                if (baseRate) {
                                    resolvedRate = baseRate / parseFloat(price);
                                    break;
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn(`âŒ Unable to resolve USDT rate for ${upper}`, error);
            } finally {
                pendingRateLookups.delete(upper);
            }

            if (!isFinite(resolvedRate) || resolvedRate <= 0) {
                resolvedRate = 0;
            }

            priceTickerCache.assetRates.set(upper, resolvedRate);
            return resolvedRate;
        }

        function aggregateAssets(rawAssets) {
            const map = new Map();
            rawAssets.forEach(item => {
                if (!item || typeof item.symbol !== "string") return;
                const symbol = item.symbol.toUpperCase();
                const amount = Number(item.amount);
                if (!symbol || !isFinite(amount) || amount <= 0) return;
                map.set(symbol, (map.get(symbol) || 0) + amount);
            });
            return Array.from(map.entries()).map(([symbol, amount]) => ({ symbol, amount }));
        }

        async function renderExchangeAssets(exchangeId, rawAssets, options = {}) {
            const container = document.getElementById(`${exchangeId}Saldo`);
            if (!container) return;

            const overrides = options.overrides || {};
            const aggregated = aggregateAssets(rawAssets);

            const brandClass = `text-cex-${String(exchangeId).toLowerCase()}`;

            if (!aggregated.length) {
                container.innerHTML = `<span class="uk-text-muted ${brandClass}">Tidak ada aset</span>`;
                localStorage.setItem(`MULTI_${exchangeId}Saldo`, "0");
                localStorage.removeItem(`MULTI_${exchangeId}_DETAIL`);
                return;
            }

            const assetsWithValues = [];
            for (const asset of aggregated) {
                const overrideRate = overrides[asset.symbol];
                let rate = typeof overrideRate === "number" ? overrideRate : await getUsdtRate(asset.symbol);
                if (!isFinite(rate) || rate < 0) rate = 0;
                const usdtValue = rate ? asset.amount * rate : 0;

                assetsWithValues.push({
                    symbol: asset.symbol,
                    amount: asset.amount,
                    rate,
                    usdtValue
                });
            }

            assetsWithValues.sort((a, b) => (b.usdtValue || 0) - (a.usdtValue || 0));

            const visibleAssets = assetsWithValues.filter(item => item.rate && item.usdtValue >= MIN_DISPLAY_USDT);

            if (!visibleAssets.length) {
                container.innerHTML = `<span class="uk-text-muted ${brandClass}">Tidak Ada</span>`;
                localStorage.setItem(`MULTI_${exchangeId}Saldo`, "0");
                localStorage.removeItem(`MULTI_${exchangeId}_DETAIL`);
                return;
            }

            const totalUsdt = visibleAssets.reduce((sum, item) => sum + item.usdtValue, 0);
            const detail = {
                total: parseFloat(totalUsdt.toFixed(2)),
                assets: visibleAssets.map(item => ({
                    symbol: item.symbol,
                    amount: parseFloat(item.amount.toFixed(8)),
                    rate: item.rate ? parseFloat(item.rate.toFixed(8)) : 0,
                    usdtValue: item.rate ? parseFloat(item.usdtValue.toFixed(2)) : 0
                }))
            };

            container.innerHTML = buildExchangeHtmlFromDetail(detail, exchangeId);
            localStorage.setItem(`MULTI_${exchangeId}Saldo`, detail.total.toFixed(2));
            localStorage.setItem(`MULTI_${exchangeId}_DETAIL`, JSON.stringify(detail));
        }

        function buildExchangeHtmlFromDetail(detail, exchangeId = '') {
            if (!detail || !Array.isArray(detail.assets) || detail.assets.length === 0) {
                return `<span class="uk-text-muted">Tidak ada aset</span>`;
            }

            const exClass = exchangeId ? `text-cex-${String(exchangeId).toLowerCase()}` : '';
            const assetLines = detail.assets.map(item => {
                const amountText = formatTokenAmount(item.amount);
                const rateText = formatRate(item.rate);
                const valueText = item.rate ? ` ${formatUsdtValue(item.usdtValue)} $` : " N/A";
                return `
                    <div class="asset-line uk-flex uk-flex-between uk-flex-wrap">
                        <span><b>${escapeHtml(item.symbol)}</b> ${amountText}</span>
                        <span>@ ${rateText} USDT</span>
                        <span>${valueText}</span>
                    </div>
                `;
            }).join("");

            const totalText = formatUsdtValue(parseFloat(detail.total || 0));
            return `
                ${assetLines}
                <hr class="uk-margin-small-top uk-margin-small-bottom">
                <b class="${exClass}">Total ${totalText} {USDT}</b>
            `;
        }

        function restoreExchangeRow(exchangeId) {
            const container = document.getElementById(`${exchangeId}Saldo`);
            if (!container) return;
            const storedDetail = localStorage.getItem(`MULTI_${exchangeId}_DETAIL`);
            if (storedDetail) {
                try {
                    const detail = JSON.parse(storedDetail);
                    container.innerHTML = buildExchangeHtmlFromDetail(detail, exchangeId);
                    return;
                } catch (error) {
                    console.warn(`âŒ Failed to parse stored detail for ${exchangeId}`, error);
                }
            }
            const saldo = parseFloat(localStorage.getItem(`MULTI_${exchangeId}Saldo`)) || 0;
            const exClass = `text-cex-${String(exchangeId).toLowerCase()}`;
            container.innerHTML = `<span class="${exClass}">${saldo.toFixed(2)} {USDT}</span>`;
        }

            // Check custom token price
            $("#cekTokensBtn").on("click", function () {
                var symbol1 = $("#random1symbol").val().toUpperCase().trim();
                if (!symbol1) {
                    if (typeof toast !== 'undefined' && toast.error) toast.error("Masukkan simbol untuk custom token.");
                    return;
                }

                $.getJSON("https://proxykanan.awokawok.workers.dev/?https://api-gcp.binance.com/api/v3/ticker/price?symbol=" + symbol1 + "USDT")
                    .done(function (response) {
                        ratePrice.random1 = parseFloat(response.price);
                        $("#random1price").prop("disabled", false).val(ratePrice.random1.toFixed(8));
                        if (typeof toast !== 'undefined' && toast.info) toast.info("Custom token ditemukan: " + symbol1 + " dengan harga " + ratePrice.random1 + " USDT");

                        // Tambahkan event listener untuk mengubah nilai custom token
                        $("#random1price").on("input", function () {
                            convertFromInput('random1');
                        });
                    })
                    .fail(function () {
                        if (typeof toast !== 'undefined' && toast.error) toast.error("Token tidak ditemukan.");
                        ratePrice.random1 = 0;
                        $("#random1price").prop("disabled", true).val('');
                    });
            });

            // Convert input dynamically
            window.convertFromInput = function(base) {
                const baseValue = parseFloat($("#" + base + "price").val());
                if (isNaN(baseValue) || baseValue <= 0) return;

                var updatedPrices = {};
                switch (base) {
                    case "usdt":
                        updatedPrices = {
                            usdt: baseValue,
                            idr: baseValue * ratePrice.idr,
                            btc: baseValue / ratePrice.btc,
                            eth: baseValue / ratePrice.eth,
                            bnb: baseValue / ratePrice.bnb,
                            random1: baseValue / ratePrice.random1
                        };
                        break;
                    case "idr":
                        updatedPrices = {
                            usdt: baseValue / ratePrice.idr,
                            idr: baseValue,
                            btc: (baseValue / ratePrice.idr) / ratePrice.btc,
                            eth: (baseValue / ratePrice.idr) / ratePrice.eth,
                            bnb: (baseValue / ratePrice.idr) / ratePrice.bnb,
                            random1: (baseValue / ratePrice.idr) / ratePrice.random1
                        };
                        break;
                    case "btc":
                        updatedPrices = {
                            usdt: baseValue * ratePrice.btc,
                            idr: baseValue * ratePrice.btc * ratePrice.idr,
                            btc: baseValue,
                            eth: baseValue * ratePrice.btc / ratePrice.eth,
                            bnb: baseValue * ratePrice.btc / ratePrice.bnb,
                            random1: baseValue * ratePrice.btc / ratePrice.random1
                        };
                        break;
                    case "eth":
                        updatedPrices = {
                            usdt: baseValue * ratePrice.eth,
                            idr: baseValue * ratePrice.eth * ratePrice.idr,
                            btc: baseValue * ratePrice.eth / ratePrice.btc,
                            eth: baseValue,
                            bnb: baseValue * ratePrice.eth / ratePrice.bnb,
                            random1: baseValue * ratePrice.eth / ratePrice.random1
                        };
                        break;
                    case "bnb":
                        updatedPrices = {
                            usdt: baseValue * ratePrice.bnb,
                            idr: baseValue * ratePrice.bnb * ratePrice.idr,
                            btc: baseValue * ratePrice.bnb / ratePrice.btc,
                            eth: baseValue * ratePrice.bnb / ratePrice.eth,
                            bnb: baseValue,
                            random1: baseValue * ratePrice.bnb / ratePrice.random1
                        };
                        break;
                    // Handle other cases (btc, eth, bnb)
                    case "random1":
                        if (ratePrice.random1 === 0) return;
                        updatedPrices = {
                            usdt: baseValue * ratePrice.random1,
                            idr: baseValue * ratePrice.random1 * ratePrice.idr,
                            btc: (baseValue * ratePrice.random1) / ratePrice.btc,
                            eth: (baseValue * ratePrice.random1) / ratePrice.eth,
                            bnb: (baseValue * ratePrice.random1) / ratePrice.bnb,
                            random1: baseValue
                        };
                        break;
                }

                // Update input fields
                updatePrices(updatedPrices, base);
            };

            // Update input fields
            function updatePrices(prices, excludeBase) {
                $.each(prices, function (key, value) {
                    if (key !== excludeBase) {
                        $("#" + key + "price").val(value ? value.toFixed(8) : '');
                    }
                });
            }
            // Fungsi untuk memperbarui harga di input
            function updatePrices(prices, excludeBase) {
                $.each(prices, function (key, value) {
                    if (key !== excludeBase) {
                        // Jika IDR, formatkan dengan pemisah ribuan
                        if (key === "idr") {
                            $("#" + key + "price").val(value ? formatIDR(value) : '');
                        } else {
                            $("#" + key + "price").val(value ? value.toFixed(8) : '');
                        }
                    }
                });
            }
            fetchRates();

        // END KALKULATOR
        const infuraApiKey = '9d0429abadc34232af7d5c0e6ab98631'; // Ganti dengan API Key Infura Anda
      
        const chains = {
            ethereum: `https://eth.llamarpc.com`,
            bsc: 'https://bsc-dataseed.binance.org/',
           //bsc:'https://binance.llamarpc.com',
            polygon: 'https://polygon-pokt.nodies.app',
            base:'https://base.llamarpc.com',
           // base: 'https://mainnet.base.org',
            arbitrum: `https://arbitrum-mainnet.infura.io/v3/${infuraApiKey}`,
            avax: `https://avalanche-mainnet.infura.io/v3/${infuraApiKey}`,
            solana: 'https://api.mainnet-beta.solana.com' 
        };
        // Fungsi untuk mendapatkan saldo aset ERC20 dan gas
        const erc20Contracts = {
            ethereum: '0xdAC17F958D2ee523a2206206994597C13D831ec7', // USDT Ethereum
            bsc: '0x55d398326f99059fF775485246999027B3197955', // USDT BSC
            polygon: '0xc2132D05D31c914a87C6611C10748AEb04B58e8F', // USDT Polygon
            base: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913', // USDC Base
            arbitrum: '0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9',
            avax: '0x9702230a8ea53601f5cd2dc00fdbc13d4df4a8c7', // USDT Arbitrum
            solana: 'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB' // USDT SPL Token Solana (Note: Solana tidak mendukung ERC20, hanya untuk referensi)
        };

        // Daftar jaringan dengan checkbox dan input terkait
        const networks = [
                { checkboxId: 'ETHEREUM', inputId: 'ethWallet' },
                { checkboxId: 'BSC', inputId: 'bscWallet' },
                { checkboxId: 'POLYGON', inputId: 'polygonWallet' },
                { checkboxId: 'BASE', inputId: 'baseWallet' },
                { checkboxId: 'ARBITRUM', inputId: 'arbitrumWallet' },
                { checkboxId: 'AVAX', inputId: 'avaxWallet' },
                { checkboxId: 'SOLANA', inputId: 'solanaWallet' }
            ];

        // Memanggil loadData saat halaman pertama kali di-load
        loadData();
        // Handle button click to show the modal
        $('#openModalKalkulator').on('click', function(event) {
            event.preventDefault(); // Prevent default behavior of anchor tag
            UIkit.modal('#calculator-modal').show();
        });

        // Simpan status checkbox dan nilai input saat terjadi perubahan
        $('input[type="checkbox"]').on('change', function () {
            const checkbox = $(this);
            const id = checkbox.attr('id');
            const isChecked = checkbox.prop('checked');

            // Simpan status checkbox ke localStorage
            localStorage.setItem(`MULTI_${id}`, isChecked);

            // Temukan input terkait dan aktifkan atau nonaktifkan
            const relatedInputs = checkbox.closest('.input-group').find('input[type="text"], input[type="number"]');
            relatedInputs.prop('disabled', !isChecked);

            // Ganti pesan toastr dengan nama inputan checkbox
            const inputName = checkbox.attr('name') || id; // Menggunakan atribut 'name' jika ada, jika tidak gunakan 'id'
            if (typeof toast !== 'undefined' && toast.success) toast.success("Status "+inputName+" Berhasil Diubah!!");
            // Simpan nilai input ke localStorage jika checkbox dicentang
            relatedInputs.each(function() {
                const input = $(this);
                const inputId = input.attr('id');
                if (isChecked) {
                    localStorage.setItem(`MULTI_${inputId}`, input.val());
                }                
            });
        });

        // Simpan nilai input ketika ada perubahan
        $('input[type="text"], input[type="number"]').on('input', function () {
            const input = $(this);
            const inputId = input.attr('id');
            const value = input.val();

            // Simpan nilai input ke localStorage
            localStorage.setItem(`MULTI_${inputId}`, value);
           
        });

        $('#SaveConfigCEXS').on('click', async function () {
            let inputKosong = false;

            // Hapus class 'input-error' sebelumnya
            $('.input-error').removeClass('input-error');

            // Periksa semua checkbox yang dicentang dan cari input yang terkait
            $('input.uk-checkbox:checked').each(function () {
                const exchangeId = $(this).attr('id');

                // Temukan input yang terkait dengan checkbox ini
                const relatedInputs = $(`#apikey${exchangeId}, #secretkey${exchangeId}, #passphrase${exchangeId}`);
                relatedInputs.each(function () {
                    if ($(this).val().trim() === '') {
                        inputKosong = true;
                        $(this).addClass('input-error'); // Tambahkan class untuk menyorot input yang kosong
                        if (typeof toast !== 'undefined' && toast.error) toast.error(`Inputan ${exchangeId} Masih Kosong.`);
                        return false; // Keluar dari loop input jika ditemukan input kosong
                    }
                });

                // Hentikan pemeriksaan jika ada input kosong
                if (inputKosong) {
                    return false; // Keluar dari loop checkbox jika ada input kosong
                }

                // Tambahkan baris ke tabel berdasarkan checkbox yang dicentang
                updateTableRowsCEXS();
            });

            // Jika ada input kosong, jangan lanjutkan proses
            if (inputKosong) {
                return; // Keluar dari fungsi jika ada input yang kosong
            }

            // Ambil semua exchange yang dicentang
            const checkedExchanges = [];
            $('input[type="checkbox"]:checked').each(function () {
                const id = $(this).attr('id');
                checkedExchanges.push(id);
            });

            // Show loading overlay only if not already active
            const isStandaloneCall = !window.BalanceCheckOverlay.isActive;
            if (isStandaloneCall) {
                window.BalanceCheckOverlay.show(
                    'Cek Saldo Exchanger',
                    'Mengambil data saldo dari exchanger...'
                );
                window.BalanceCheckOverlay.updateProgress(10, `Memproses ${checkedExchanges.length} exchanger(s)...`);
            }

            let allChecksPassed = true; // Flag untuk memastikan semua pengecekan berhasil

            // Jalankan fungsi pengecekan untuk setiap exchange yang dicentang
            // Tunggu sampai semua pengecekan selesai dengan async/await
            const totalExchanges = checkedExchanges.length;
            let processedCount = 0;

            await Promise.all(checkedExchanges.map(async function (exchange) {
                try {
                    const progressPercent = 20 + (processedCount / totalExchanges) * 70;
                    window.BalanceCheckOverlay.updateProgress(progressPercent, `Memproses ${exchange}...`);

                    switch (exchange) {
                        case 'BINANCE':
                            await cekAssetBinance(); // Tunggu hingga selesai
                            break;
                        case 'GATE':
                            await cekAssetGate(); // Tunggu hingga selesai
                            break;
                        case 'BITGET':
                            await cekAssetBitget(); // Tunggu hingga selesai
                            break;
                        case 'KUCOIN':
                            await cekAssetKucoin(); // Tunggu hingga selesai
                            break;
                        case 'MEXC':
                            await cekAssetMexc(); // Tunggu hingga selesai
                            break;
                        case 'BYBIT':
                            await cekAssetBybit(); // Tunggu hingga selesai
                            break;
                        case 'INDODAX':
                            await cekAssetIndodax(); // Tunggu hingga selesai
                            break;
                        default:
                            break;
                    }
                    processedCount++;
                } catch (error) {
                    // Jika pengecekan gagal, tampilkan pesan error

                    allChecksPassed = false; // Tandai bahwa ada pengecekan yang gagal
                    $('#TotalSaldoCEX').text(`???`);
                    processedCount++;
                }
            }));

            // Jika ada pengecekan yang gagal, beri tahu pengguna dan berhenti
            if (!allChecksPassed) {
                // Emit completion on error so combined flow can continue
                $(document).trigger('CEXCheckCompleted');
                // Hide overlay on error only if standalone call
                if (isStandaloneCall) {
                    setTimeout(() => {
                        window.BalanceCheckOverlay.hide();
                    }, 200);
                }
                // Jika pengecekan gagal, tampilkan pesan error
                return; // Keluar dari fungsi jika ada pengecekan yang gagal
            }

            window.BalanceCheckOverlay.updateProgress(95, 'Menghitung total saldo...');

            // Setelah semua pengecekan selesai dan berhasil, hitung total saldo
            await getTotalSaldoCEXS(); // Panggil setelah semua pengecekan selesai

            // Tunggu hingga tabel exchanger benar-benar terisi dan total siap
            await waitFor(isCexTableReady, 15000, 100);

            window.BalanceCheckOverlay.updateProgress(100, 'Memeriksa Ulang Data...');

            ShowLabelModal("load");

            // Emit completion event for combined flow listeners
            $(document).trigger('CEXCheckCompleted');

            // Sembunyikan overlay bila pemanggilan mandiri (bukan combined)
            if (isStandaloneCall) {
                setTimeout(() => {
                    window.BalanceCheckOverlay.hide();
                }, 200);
            }

        });

         // Fungsi untuk menghitung total saldo semua CEX
         function getTotalSaldoCEXS() {
            let totalSaldo = 0;

            // Menjumlahkan saldo dari setiap exchange yang diaktifkan
            $('input[type="checkbox"]:checked').each(function () {
                const id = $(this).attr('id');
                const saldoKey = `MULTI_${id}Saldo`;
                const saldo = parseFloat(localStorage.getItem(saldoKey)) || 0;
                totalSaldo += saldo;
            });

            // Simpan waktu terakhir diperbarui ke localStorage
            var formattedTime = getFormattedTime();
            localStorage.setItem('MULTI_lastUpdateCEX', formattedTime);
            localStorage.setItem('MULTI_TotalSaldoCEX', totalSaldo);
            // Tampilkan total saldo
            $('#TotalSaldoCEX').text(`${totalSaldo.toFixed(2)} $`);

            // Update summary cards
            updateSummaryCards();
        }

        // Function to update summary cards
        function updateSummaryCards() {
            const totalCEX = parseFloat(localStorage.getItem('MULTI_TotalSaldoCEX')) || 0;
            const totalWallet = parseFloat(localStorage.getItem('MULTI_TotalSaldoChain')) || 0;
            const totalAsset = totalCEX + totalWallet;
            const modalAwal = parseFloat(localStorage.getItem('MULTI_MODALAWAL')) || 0;
            const pnl = totalAsset - modalAwal;
            const usdtRate = parseFloat(localStorage.getItem('MULTI_USDTRate')) || 0;

            const formatToIDR = (usdValue) => {
                if (usdtRate > 0) {
                    return `Rp ${new Intl.NumberFormat('id-ID').format(usdValue * usdtRate)}`;
                }
                return 'Rp 0';
            };

            // Update summary cards
            $('#summaryTotalCEX').text('$' + totalCEX.toFixed(2));
            $('#summaryTotalCEX_IDR').text(formatToIDR(totalCEX));
            $('#summaryTotalWallet').text('$' + totalWallet.toFixed(2));
            $('#summaryTotalWallet_IDR').text(formatToIDR(totalWallet));
            $('#summaryTotalAsset').text('$' + totalAsset.toFixed(2));
            $('#summaryTotalAsset_IDR').text(formatToIDR(totalAsset));
            $('#summaryPNL').text((pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2));
            $('#summaryPNL_IDR').text(formatToIDR(pnl));

            // Add positive/negative class for PNL
            const pnlCard = $('#summaryPNLCard');
            pnlCard.removeClass('positive negative');
            if (pnl > 0) {
                pnlCard.addClass('positive');
            } else if (pnl < 0) {
                pnlCard.addClass('negative');
            }

            // Also update the info pill cards
            const pnlPillCard = $('#pnlCard');
            pnlPillCard.removeClass('positive negative');
            if (pnl > 0) {
                pnlPillCard.addClass('positive');
            } else if (pnl < 0) {
                pnlPillCard.addClass('negative');
            }
        }

        $('#SaveWalletChains').on('click', async function () {
            $(this).prop('disabled', true);  // Menonaktifkan tombol selama proses

            // Show loading overlay only if not already active
            const isStandaloneCall = !window.BalanceCheckOverlay.isActive;
            if (isStandaloneCall) {
                window.BalanceCheckOverlay.show(
                    'Cek Saldo Wallet',
                    'Mengambil data saldo dari wallet chains...'
                );
                window.BalanceCheckOverlay.updateProgress(10, 'Memvalidasi input...');
            }

            $('#LTotalSaldoWallets').text('');
            $('#TotalSaldoWallets').text('');

            const selectedChains = {
                ethereum: $('#ETHEREUM').is(':checked') ? $('#ethWallet').val() : null,
                bsc: $('#BSC').is(':checked') ? $('#bscWallet').val() : null,
                polygon: $('#POLYGON').is(':checked') ? $('#polygonWallet').val() : null,
                base: $('#BASE').is(':checked') ? $('#baseWallet').val() : null,
                arbitrum: $('#ARBITRUM').is(':checked') ? $('#arbitrumWallet').val() : null,
                avax: $('#AVAX').is(':checked') ? $('#avaxWallet').val() : null,
                solana: $('#SOLANA').is(':checked') ? $('#solanaWallet').val() : null
            };

            const invalidChains = Object.keys(selectedChains).filter(chain => 
                $(`#${chain.toUpperCase()}`).is(':checked') && 
                (selectedChains[chain] === null || selectedChains[chain].trim() === '')
            );

            if (invalidChains.length > 0) {
                $('#output_chain').html(
                    `<tr><td colspan="4" class="uk-text-danger">Wallet Chain ${invalidChains.join(', ')} harus diisi!</td></tr>`
                );
                $('#assetTableWallet').show();
                $(this).prop('disabled', false);  // Mengaktifkan kembali tombol jika ada error
                // Emit completion on error/invalid so combined flow can continue
                $(document).trigger('WalletCheckCompleted');
                if (isStandaloneCall) window.BalanceCheckOverlay.hide(); // Hide overlay on error only if standalone
                return;
            }

            const validChains = Object.keys(selectedChains).filter(chain => selectedChains[chain]);

            if (validChains.length === 0) {
                $('#output_chain').html('<tr><td colspan="4">Pilih Min 1 Chain!!</td></tr>');
                $('#assetTableWallet').show();
                $(this).prop('disabled', false);
                // Emit completion on error/invalid so combined flow can continue
                $(document).trigger('WalletCheckCompleted');
                if (isStandaloneCall) window.BalanceCheckOverlay.hide(); // Hide overlay on error only if standalone
                return;
            }


            $('#output_chain').html('<tr><td colspan="4">Loading...</td></tr>');
            $('#assetTableWallet').show();
            window.BalanceCheckOverlay.updateProgress(30, `Memproses ${validChains.length} chain(s)...`);

            try {
                window.BalanceCheckOverlay.updateProgress(40, 'Mengambil rate token...');
                const tokenRates = await fetchTokenRates();

                if (!tokenRates || Object.keys(tokenRates).length === 0) {
                    throw new Error('Tidak dapat mengambil data rate token.');
                }

                window.BalanceCheckOverlay.updateProgress(60, 'Mengambil saldo dari wallet chains...');

                const results = await Promise.all(validChains.map((chain, index) => {
                    // Update progress for each chain
                    const progressPercent = 60 + (index / validChains.length) * 30;
                    window.BalanceCheckOverlay.updateProgress(progressPercent, `Memproses ${chain.toUpperCase()}...`);

                    return chain === 'solana' ?
                        getSolanaBalance(selectedChains[chain], tokenRates) :
                        getAssetBalancesEVM(chains[chain], erc20Contracts[chain], selectedChains[chain], chain, tokenRates);
                }));

                window.BalanceCheckOverlay.updateProgress(90, 'Menampilkan hasil ke tabel...');

                $('#output_chain').html(results.map(result => {
                    if (result.error) {
                        return `<tr><td colspan="4">ERROR : ${result.error}</td></tr>`;
                    } else {
                        return `
                            <tr data-chain="${result.chain.toUpperCase()}">
                                <td class="chain-label">
                                    <a class="uk-link-muted text-chain-${result.chain.toLowerCase()}" href="${result.walletLink}" target="_blank">
                                        ${result.chain.toUpperCase()}
                                    </a>
                                </td>
                                <td class="uk-text-center">${result.assetBalance} ${result.assetSymbol}</td>
                                <td class="uk-text-center">${result.gasBalance} ${result.gasSymbol} [${result.gasBalanceInUSD}]</td>
                                <td class="uk-text-right">${result.totalBalanceInUSD} USDT</td>
                            </tr>
                        `;
                    }
                }).join(''));

                // Wait for DOM to update the table
                await new Promise(resolve => setTimeout(resolve, 100));

                // Simpan data ke localStorage setelah semua selesai
                const assetData = results.filter(result => !result.error).map(result => {
                    return {
                        chain: result.chain,
                        assetBalance: parseFloat(result.assetBalance),
                        assetSymbol: result.assetSymbol,
                        gasBalance: parseFloat(result.gasBalance),
                        gasSymbol: result.gasSymbol,
                        usdtGas: parseFloat(result.gasBalanceInUSD),
                        total: parseFloat(result.totalBalanceInUSD),
                        walletLink: result.walletLink,
                    };
                }).filter(item => item !== null);

                if (assetData.length > 0) {
                    window.BalanceCheckOverlay.updateProgress(95, 'Menyimpan data...');

                    localStorage.setItem('MULTI_assetDataCEX', JSON.stringify(assetData));

                    const formattedTime = getFormattedTime();
                    localStorage.setItem('MULTI_lastUpdateChain', formattedTime);

                    const totalUSDT = assetData.reduce((sum, data) => sum + data.total, 0);
                    $('#LTotalSaldoWallets').text("Total");
                    $('#TotalSaldoWallets').text(totalUSDT.toFixed(2) + " $");
                    localStorage.setItem('MULTI_TotalSaldoChain', totalUSDT.toFixed(2));

                    // Update summary cards
                    updateSummaryCards();

                    // Tunggu hingga tabel wallet benar-benar terisi dan total siap
                    await waitFor(() => isWalletTableReady(results), 15000, 100);

                    window.BalanceCheckOverlay.updateProgress(100, 'Memeriksa Ulang Data...');
                } else {
                    throw new Error('Tidak ada data valid untuk disimpan.');
                }
            } catch (error) {
                localStorage.setItem('MULTI_TotalSaldoChain', '0');
                $('#output_chain').html(
                    `<tr><td colspan="4">ERROR : ${error.message}</td></tr>`
                );
                // Emit completion on error so combined flow can continue
                $(document).trigger('WalletCheckCompleted');
                if (isStandaloneCall) {
                    setTimeout(() => window.BalanceCheckOverlay.hide(), 200);
                }
            }

            ShowLabelModal("load");
            updateSummaryCards();

            // Emit completion event for combined flow listeners (success path)
            $(document).trigger('WalletCheckCompleted');

            // Hide overlay after completion only if standalone call
            if (isStandaloneCall) {
                setTimeout(() => {
                    window.BalanceCheckOverlay.hide();
                }, 200);
            }

            $(this).prop('disabled', false);  // Mengaktifkan kembali tombol setelah selesai
        });

        // update tabel cex
        function updateTableRowsCEXS() {
            let totalSaldo = 0;

            $('input[type="checkbox"]').each(function () {
                const checkbox = $(this);
                const id = checkbox.attr('id');
                const isChecked = checkbox.prop('checked');
                const saldoKey = `MULTI_${id}Saldo`;
                const tableRow = $(`#assetTableCexs tr:contains(${id})`);

                if (isChecked) {
                    tableRow.show(); // Tampilkan baris jika checkbox diaktifkan

                    // Ambil saldo dari localStorage setelah pengecekan
                    const saldo = parseFloat(localStorage.getItem(saldoKey)) || 0;
                    restoreExchangeRow(id);

                    // Menambahkan saldo ke totalSaldo
                    totalSaldo += saldo;

                } else {
                    tableRow.hide(); // Sembunyikan baris jika checkbox dinonaktifkan

                    // Set saldo menjadi 0 di localStorage dan di tabel
                    localStorage.setItem(saldoKey, "0");
                    localStorage.removeItem(`MULTI_${id}_DETAIL`);
                    $(`#${id}Saldo`).text("0 {USDT}");
                }
            });

            // Memperbarui total saldo di tabel
            $('#TotalSaldoCEX').text(`${totalSaldo.toFixed(2)} $`);
        }

        async function cekAssetBitget() {
            const apiKey = $("#apikeyBITGET").val();
            const apiSecret = $("#secretkeyBITGET").val();
            const passphrase = $("#passphraseBITGET").val();
            if (!apiKey || !apiSecret || !passphrase) return;

            const apiUrl = "https://cors-anywhere.com/https://api.bitget.com/api/v2/spot/account/assets";
            const timestamp = Date.now().toString();
            const preSignature = timestamp + "GET" + "/api/v2/spot/account/assets";
            const signature = CryptoJS.HmacSHA256(preSignature, apiSecret).toString(CryptoJS.enc.Base64);

            const headers = {
                "ACCESS-KEY": apiKey,
                "ACCESS-SIGN": signature,
                "ACCESS-TIMESTAMP": timestamp,
                "ACCESS-PASSPHRASE": passphrase,
            };

            try {
                $("#BITGETSaldo").text("Loading...");
                const response = await fetch(apiUrl, { method: "GET", headers });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                const assets = Array.isArray(data?.data)
                    ? data.data.map(item => ({
                        symbol: item.coin,
                        amount:
                            (parseFloat(item.available || 0) || 0) +
                            (parseFloat(item.frozen || 0) || 0)
                    }))
                    : [];

                await renderExchangeAssets("BITGET", assets);
                console.log("Cek Asset Bitget:", assets);
            } catch (error) {
                $("#BITGETSaldo").text("ERROR").addClass("error");
                localStorage.setItem('MULTI_BITGETSaldo', "0");
                localStorage.removeItem('MULTI_BITGET_DETAIL');
                if (typeof toast !== 'undefined' && toast.error) toast.error("Error Pengecekan Market Bitget: " + error);
                console.error(error);
            }
        }

        async function cekAssetKucoin() {
            const apiKey = $("#apikeyKUCOIN").val();
            const apiSecret = $("#secretkeyKUCOIN").val();
            const passphrase = $("#passphraseKUCOIN").val();
            if (!apiKey || !apiSecret || !passphrase) return;

            const apiUrl = "https://api.kucoin.com/api/v1/accounts";
            const timestamp = Date.now().toString();
            const preSignature = timestamp + "GET" + "/api/v1/accounts";
            const signature = CryptoJS.HmacSHA256(preSignature, apiSecret).toString(CryptoJS.enc.Base64);
            const passphraseENC = CryptoJS.HmacSHA256(passphrase, apiSecret).toString(CryptoJS.enc.Base64);

            const headers = {
                "KC-API-KEY": apiKey,
                "KC-API-SIGN": signature,
                "KC-API-TIMESTAMP": timestamp,
                "KC-API-PASSPHRASE": passphraseENC,
                "KC-API-KEY-VERSION": "3",
                "Content-Type": "application/json"
            };

            try {
                $("#KUCOINSaldo").text("Loading...");
                const response = await fetch(apiUrl, { method: "GET", headers });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                const assets = Array.isArray(data?.data)
                    ? data.data.map(item => ({
                        symbol: item.currency,
                        amount: parseFloat(item.balance || item.available || 0) || 0
                    }))
                    : [];

                await renderExchangeAssets("KUCOIN", assets);
                console.log("Cek Asset Kucoin:", assets);
            } catch (error) {
                $("#KUCOINSaldo").text("ERROR").addClass("error");
                localStorage.setItem('MULTI_KUCOINSaldo', "0");
                localStorage.removeItem('MULTI_KUCOIN_DETAIL');
                if (typeof toast !== 'undefined' && toast.error) toast.error("Error Pengecekan Market Kucoin: " + error);
                console.error(error);
            }
        }

        async function cekAssetBybit() {
            const apiKey = $("#apikeyBYBIT").val();
            const apiSecret = $("#secretkeyBYBIT").val();
            if (!apiKey || !apiSecret) return;

            const recvWindow = 5000;
            const timestamp = Date.now().toString();
            const host = "https://api.bybit.com";
            const method = "GET";
            const url = "/v5/account/wallet-balance";
            const queryString = "accountType=UNIFIED";

            function calculateSignature(secret, timestamp, recvWindow, queryString) {
                const dataToSign = `${timestamp}${apiKey}${recvWindow}${queryString}`;
                return CryptoJS.HmacSHA256(dataToSign, secret).toString(CryptoJS.enc.Hex);
            }

            const sign = calculateSignature(apiSecret, timestamp, recvWindow, queryString);
            const fullUrl = `${host}${url}?${queryString}`;

            try {
                $("#BYBITSaldo").text("Loading...");
                const response = await fetch(fullUrl, {
                    method,
                    headers: {
                        Accept: "application/json",
                        "Content-Type": "application/json",
                        "X-BAPI-API-KEY": apiKey,
                        "X-BAPI-TIMESTAMP": timestamp,
                        "X-BAPI-RECV-WINDOW": recvWindow.toString(),
                        "X-BAPI-SIGN": sign,
                    }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                const coinList = data?.result?.list?.[0]?.coin;
                const assets = Array.isArray(coinList)
                    ? coinList.map(item => ({
                        symbol: item.coin,
                        amount: parseFloat(item.equity || item.walletBalance || 0) || 0
                    }))
                    : [];

                await renderExchangeAssets("BYBIT", assets);
                console.log("Cek Asset Bybit:", assets);
            } catch (error) {
                $("#BYBITSaldo").text("ERROR").addClass("error");
                localStorage.setItem('MULTI_BYBITSaldo', "0");
                localStorage.removeItem('MULTI_BYBIT_DETAIL');
                if (typeof toast !== 'undefined' && toast.error) toast.error("Error Pengecekan Market Bybit: " + error);
                console.error(error);
            }
        }
        
        async function cekAssetIndodax() {
            const apiKey = $("#apikeyINDODAX").val();
            const secretKey = $("#secretkeyINDODAX").val();
            if (!apiKey || !secretKey) return;
            const timestamp = Date.now();
            const recvWindow = 5000;
            const method = "getInfo";
            const requestBody = `method=${method}&timestamp=${timestamp}&recvWindow=${recvWindow}`;
            const signature = CryptoJS.HmacSHA512(requestBody, secretKey).toString();

            try {
                $("#INDODAXSaldo").text("Loading...");

                const response = await $.ajax({
                    url: "https://proxykiri.awokawok.workers.dev/?https://indodax.com/tapi",
                    type: "POST",
                    headers: {
                        "Key": apiKey,
                        "Sign": signature
                    },
                    data: requestBody
                });

                if (response.success) {
                    const balance = response.return.balance;
                    const assets = Object.entries(balance || {}).map(([symbol, value]) => ({
                        symbol: symbol.toUpperCase(),
                        amount: parseFloat(value || 0) || 0
                    }));

                    const rateIDR = await USDTIDR(1);
                    const overrides = {};
                    if (rateIDR && isFinite(rateIDR) && rateIDR > 0) {
                        overrides.IDR = 1 / rateIDR;
                    }

                    await renderExchangeAssets("INDODAX", assets, { overrides });
                    console.log("Cek Asset Indodax:", assets);
                } else {
                    $("#INDODAXSaldo").text("NO DATA").addClass("error");
                    localStorage.setItem("MULTI_INDODAXSaldo", "0");
                    localStorage.removeItem("MULTI_INDODAX_DETAIL");
                }
            } catch (error) {
                $("#INDODAXSaldo").text("ERROR").addClass("error");
                localStorage.setItem("MULTI_INDODAXSaldo", "0");
                localStorage.removeItem("MULTI_INDODAX_DETAIL");
                if (typeof toast !== 'undefined' && toast.error) toast.error("Error Pengecekan Asset Indodax: " + error);
                console.error(error);
            }
        }

        async function cekAssetMexc() {
            const PROXY_BASE = "https://cors-proxy-rosy.vercel.app/api/proxy"; // ganti jika perlu
            const container = document.querySelector("#MEXCSaldo");
            const apiKey = (document.querySelector("#apikeyMEXC")?.value || "").trim();
            const apiSecret = (document.querySelector("#secretkeyMEXC")?.value || "").trim();
            const recvWindow = 5000;

            const setOut = (html) => { if (container) container.innerHTML = html; };

            try {
                setOut("Loading...");
                if (!apiKey || !apiSecret) throw new Error("API Key & Secret wajib diisi");

                // 1) ambil server time MEXC via proxy (untuk kurangi clock-skew)
                let serverTime = Date.now();
                try {
                    const timeUrl = `${PROXY_BASE}?url=${encodeURIComponent("https://api.mexc.com/api/v3/time")}`;
                    const rTime = await fetch(timeUrl);
                    const jTime = await rTime.json().catch(() => ({}));
                    if (typeof jTime?.serverTime === "number") serverTime = jTime.serverTime;
                } catch {
                    /* abaikan, lanjut pakai Date.now() */
                }

                // 2) siapkan query & signature (HMAC-SHA256 hex)
                const params = { recvWindow, timestamp: String(serverTime) };
                const usp = new URLSearchParams();
                for (const k of Object.keys(params)) usp.append(k, String(params[k]));
                const queryString = usp.toString(); // recvWindow=5000&timestamp=...
                const signature = CryptoJS.HmacSHA256(queryString, apiSecret).toString(CryptoJS.enc.Hex);

                // 3) rakit target URL MEXC + signature, lalu bungkus ke proxy (HARUS encode)
                const targetUrl = `https://api.mexc.com/api/v3/account?${queryString}&signature=${signature}`;
                const proxiedUrl = `${PROXY_BASE}?url=${encodeURIComponent(targetUrl)}`;

                // 4) panggil API lewat proxy
                const headers = { "X-MEXC-APIKEY": apiKey, "Content-Type": "application/json" };
                const resp = await fetch(proxiedUrl, { method: "GET", headers });

                // kadang non-200 tapi berisi JSON error {code,msg}
                const rawText = await resp.text();
                let data; try { data = JSON.parse(rawText); } catch { data = rawText; }

                if (!resp.ok || (data && typeof data === "object" && data.code && data.msg)) {
                    const code = data?.code ?? resp.status;
                    const msg  = data?.msg ?? resp.statusText ?? "Unknown error";
                    throw new Error(`MEXC error (${code}): ${msg}`);
                }

                // 5) olah saldo
                const balances = Array.isArray(data?.balances) ? data.balances : null;
                if (!balances) throw new Error("Tidak ada data balances dari MEXC");

                const assets = balances.map(item => ({
                    symbol: item.asset,
                    amount:
                        (parseFloat(item.free || 0) || 0) +
                        (parseFloat(item.locked || 0) || 0)
                }));

                await renderExchangeAssets("MEXC", assets);
                console.log("Cek Asset MEXC:", assets);

            } catch (error) {
                try {
                    localStorage.setItem('MULTI_MEXCSaldo', "0");
                    localStorage.removeItem('MULTI_MEXC_DETAIL');
                } catch {}
                setOut(`<span class="uk-text-danger">ERROR</span><br/><small>${escapeHtml(error.message || String(error))}</small>`);
                if (typeof toast !== 'undefined' && toast.error) toast.error("Error Pengecekan MEXC: " + (error.message || error));
                console.error(error);
            }
        }

        async function cekAssetBinance() {
            const apiKey = $("#apikeyBINANCE").val();
            const apiSecret = $("#secretkeyBINANCE").val();
            if (!apiKey || !apiSecret) return;

            const apiUrl = "https://api-gcp.binance.com/api/v3/account";
            const timestamp = Date.now();
            const queryString = `timestamp=${timestamp}`;
            const signature = CryptoJS.HmacSHA256(queryString, apiSecret).toString(CryptoJS.enc.Hex);
            const fullUrl = `${apiUrl}?${queryString}&signature=${signature}`;

            const headers = { "X-MBX-APIKEY": apiKey };

            try {
                $("#BINANCESaldo").text("Loading...");

                const response = await fetch(fullUrl, { method: "GET", headers });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                if (!data || !Array.isArray(data.balances)) throw new Error("Tidak ada data balance");

                const assets = data.balances.map(item => ({
                    symbol: item.asset,
                    amount:
                        (parseFloat(item.free || 0) || 0) +
                        (parseFloat(item.locked || 0) || 0)
                }));

                await renderExchangeAssets("BINANCE", assets);
                console.log("Cek Asset Binance:", assets);
            } catch (error) {
                $("#BINANCESaldo").text("ERROR").addClass("error");
                localStorage.setItem('MULTI_BINANCESaldo', "0");
                localStorage.removeItem('MULTI_BINANCE_DETAIL');
                if (typeof toast !== 'undefined' && toast.error) toast.error("Error Pengecekan Market Binance: " + error.message);
                console.error(error);
            }
        }

        async function cekAssetGate() {
            const apiKey = $("#apikeyGATE").val();
            const apiSecret = $("#secretkeyGATE").val();
            if (!apiKey || !apiSecret) return;

            const host = "https://cors-proxy-rosy.vercel.app/api/proxy?url=https://api.gateio.ws";
            const prefix = "/api/v4"; 
            const method = "GET";
            const url = "/spot/accounts";

            const query_param = "";
            const body_param = '';
            const timestamp = Math.floor(Date.now() / 1000);
            const body_hash = CryptoJS.SHA512(body_param).toString();
            const sign_string = `${method}\n${prefix}${url}\n${query_param}\n${body_hash}\n${timestamp}`;
            const sign = CryptoJS.HmacSHA512(sign_string, apiSecret).toString();
            const full_url = host + prefix + url;

            try {
                $("#GATESaldo").text("Loading...");
                const response = await fetch(full_url, {
                    method,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Timestamp': timestamp,
                        'KEY': apiKey,
                        'SIGN': sign
                    }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                const assets = Array.isArray(data)
                    ? data.map(item => ({
                        symbol: item.currency,
                        amount:
                            (parseFloat(item.available || 0) || 0) +
                            (parseFloat(item.locked || 0) || 0)
                    }))
                    : [];

                await renderExchangeAssets("GATE", assets);
                console.log("Cek Asset Gate:", assets);
            } catch (error) {
                $("#GATESaldo").text("ERROR").addClass("error");
                localStorage.setItem('MULTI_GATESaldo', "0");
                localStorage.removeItem('MULTI_GATE_DETAIL');
                if (typeof toast !== 'undefined' && toast.error) toast.error("Error Pengecekan Market Gate: " + error);
                console.error(error);
            }
        }
 
        //fungsi update history PNL
        $('#UpdateHistoryPNL').on('click', async function () {
            // Memanggil fungsi untuk mengecek saldo assets di wallets (all chain)
            await $('#SaveWalletChains').trigger('click'); 

            // Memanggil fungsi untuk mengecek asset di CEX
            $('#SaveConfigCEXS').trigger('click');
            // Menyimpan waktu saat data diperbarui
            var formattedTime = getFormattedTime();
            // Simpan waktu terakhir diperbarui ke localStorage
            localStorage.setItem('MULTI_lastUpdatePNL', formattedTime);               

            // Retrieve data from localStorage
            const saldoExchanger = JSON.parse(localStorage.getItem('MULTI_TotalSaldoCEX'));
            const assetDataChain = JSON.parse(localStorage.getItem('MULTI_TotalSaldoChain'));
            const modalawal = JSON.parse(localStorage.getItem('MULTI_MODALAWAL'));
            const saldoAkhir = Number(saldoExchanger) + Number(assetDataChain);
            const pnl = Number(saldoAkhir) - Number(modalawal);
            console.log("-----------------------");
            console.log("Saldo Exchanger: " + saldoExchanger);
            console.log("Saldo Chain: " + assetDataChain);
            console.log("Saldo Awal: " + modalawal);
            console.log("Saldo Akhir: " + saldoAkhir);
            console.log("Time: " + formattedTime);

            addTableHistory(formattedTime,Number(modalawal) ,Number(saldoAkhir) ,pnl,"update")
                
        });

       // Fungsi Save Modal
        $('#SaveModal').on('click', function () {
            const rawModalAwal = parseFloat($("#MODALAWAL").val());
            const normalizedModalAwal = isNaN(rawModalAwal) ? 0 : Number(rawModalAwal.toFixed(2));
            $("#MODALAWAL").val(normalizedModalAwal.toFixed(2));
            var formattedTime = getFormattedTime();

            // Simpan waktu terakhir diperbarui ke localStorage
            localStorage.setItem('MULTI_lastUpdatePNL', formattedTime);
            localStorage.setItem('MULTI_MODALAWAL', normalizedModalAwal.toFixed(2));
            if (typeof toast !== 'undefined' && toast.success) toast.success("SIMPAN MODAL AWAL BERHASIL [ " + formattedTime + " ] ");

            // Ambil data untuk pengisian history
            const saldoExchanger = JSON.parse(localStorage.getItem('MULTI_TotalSaldoCEX'));
            const assetDataChain = JSON.parse(localStorage.getItem('MULTI_TotalSaldoChain'));
            const saldoAkhir = Number(saldoExchanger) + Number(assetDataChain);

            addTableHistory(formattedTime, normalizedModalAwal, Number(saldoAkhir), 0, "start");
            
           // location.reload();
            LoadTableHistory()
            ShowLabelModal("start")
            loadData();
        });

        // Fungsi Reset Modal
        $('#ResetModal').on('click', async function () {
            var formattedTime = getFormattedTime();
            await $('#SaveWalletChains').trigger('click');

            // Memanggil fungsi untuk mengecek asset di CEX
            $('#SaveConfigCEXS').trigger('click');
            // Simpan waktu terakhir diperbarui ke localStorage
            localStorage.setItem('MULTI_lastUpdatePNL', formattedTime);
            if (typeof toast !== 'undefined' && toast.success) toast.success("RESET MODAL BERHASIL [ " + formattedTime + " ] ");

            // Ambil data untuk pengisian history
            const saldoExchanger = JSON.parse(localStorage.getItem('MULTI_TotalSaldoCEX'));
            const assetDataChain = JSON.parse(localStorage.getItem('MULTI_TotalSaldoChain'));
            const saldoAkhir = Number(saldoExchanger) + Number(assetDataChain);

            // Set modal awal ke saldo total saat ini (reset)
            localStorage.setItem('MULTI_MODALAWAL', saldoAkhir.toFixed(2));

            // Update input field modal awal dengan nilai total saat ini
            $("#MODALAWAL").val(saldoAkhir.toFixed(2));

            addTableHistory(formattedTime,Number(saldoAkhir) ,Number(saldoAkhir),0,"reset");

            // Reload halaman agar modal awal sesuai dengan total modal saat ini
            setTimeout(() => {
                location.reload();
            }, 1000); // Delay 1 detik untuk memastikan toast notification terlihat
        });
        
        function addTableHistory(date,awal,akhir,pnl,action){ // Tambahkan data ke riwayat

              const history = JSON.parse(localStorage.getItem('MULTI_history')) || [];
              const newHistoryEntry = {
                  date: date,
                  saldoAwal: awal.toFixed(2),  // Modal awal diset ke saldo total saat ini
                  saldoAkhir: akhir.toFixed(2), // Modal akhir tetap sama karena reset
                  pnl: pnl.toFixed(2),  // Tidak ada perubahan PNL saat reset
                  action: action  // Set action ke "reset"
              };
              history.unshift(newHistoryEntry); // Tambahkan entri ke array di posisi awal
              // Simpan seluruh riwayat (biarkan pagination yang membatasi tampilan)
              localStorage.setItem('MULTI_history', JSON.stringify(history));
              if (typeof toast !== 'undefined' && toast.info) toast.info("MODAL "+action.toUpperCase()+" BERHASIL.");
              LoadTableHistory()
        }

        function LoadTableHistory(){
          // Memuat data riwayat PNL dari localStorage
          const history = JSON.parse(localStorage.getItem('MULTI_history')) || [];
                  // Hitung paging
                  const totalItems = history.length;
                  const totalPages = Math.max(1, Math.ceil(totalItems / PNL_PAGE_SIZE));
                  if (pnlCurrentPage > totalPages - 1) pnlCurrentPage = totalPages - 1;
                  if (pnlCurrentPage < 0) pnlCurrentPage = 0;

                  // Update kontrol paging
                  $('#pnlPageInfo').text(`Halaman ${totalItems === 0 ? 0 : (pnlCurrentPage + 1)}/${totalPages}`);
                  $('#pnlPrev').prop('disabled', pnlCurrentPage <= 0 || totalItems === 0);
                  $('#pnlNext').prop('disabled', pnlCurrentPage >= totalPages - 1 || totalItems === 0);

                  // Kosongkan tabel sebelum render
                  $('#assetTablePNL tbody').empty();

                  if (history.length > 0) {
                      const start = pnlCurrentPage * PNL_PAGE_SIZE;
                      const end = start + PNL_PAGE_SIZE;
                      const pageItems = history.slice(start, end);

                      // Render data riwayat ke tabel PNL (per halaman)
                      pageItems.forEach(entry => {
                          // Tentukan kelas untuk kolom action
                          let actionClass = '';
                          let actionText = entry.action.toUpperCase(); // memastikan huruf kapital

                          // Sesuaikan dengan nilai action
                          if (entry.action === 'update') {
                              actionClass = 'uk-text-success'; // UIkit sukses
                              actionText = 'Update';
                          } else if (entry.action === 'start') {
                              actionClass = 'uk-text-secondary'; // UIkit danger
                              actionText = 'Start';
                          } else if (entry.action === 'reset') {
                              actionClass = 'uk-text-warning'; // UIkit warning
                              actionText = 'Reset';
                          }

                          // Tentukan kelas untuk pnl (untuk warna hijau, merah, atau biru)
                          let pnlClass = '';
                          let pnlValue = parseFloat(entry.pnl); // Pastikan pnl adalah angka

                          if (pnlValue < 0) {
                              pnlClass = 'uk-text-danger'; // Merah jika pnl < 0
                          } else if (pnlValue > 0) {
                              pnlClass = 'uk-text-success'; // Hijau jika pnl > 0
                          } else {
                              pnlClass = 'uk-text-primary'; // Biru jika pnl = 0
                          }

                          // Render row dengan kelas yang sesuai
                          const row = `
                              <tr>
                                  <td>${entry.date}</td>
                                  <td><b>${entry.saldoAwal}</b></td>
                                  <td><b>${entry.saldoAkhir}<b></td>
                                  <td><b><span class="${pnlClass}">${entry.pnl}</span></b></td> <!-- Penambahan warna pada pnl -->
                                  <td><b><span class="${actionClass}">${actionText}</span></b></td> <!-- Penambahan warna pada action -->
                              </tr>
                          `;
                          $('#assetTablePNL tbody').append(row);
                      });
                  } else {
                      // Tampilkan baris kosong jika tidak ada data
                      const emptyRow = `
                        <tr class="uk-text-center uk-text-muted">
                            <td colspan="5">Belum ada data</td>
                        </tr>`;
                      $('#assetTablePNL tbody').append(emptyRow);
                      $('#pnlPageInfo').text('Halaman 0/1');
                      $('#pnlPrev').prop('disabled', true);
                      $('#pnlNext').prop('disabled', true);
                  }
        }

        function ShowLabelModal(method) {
            // Ambil data dari localStorage
            const saldoExchanger = JSON.parse(localStorage.getItem('MULTI_TotalSaldoCEX')) || 0;
            const saldoAllChain = JSON.parse(localStorage.getItem('MULTI_TotalSaldoChain')) || 0;
            const modalAwal = JSON.parse(localStorage.getItem('MULTI_MODALAWAL')) || 0;

            let saldoAkhir = 0;
            let pnl = 0;

            // Logika berdasarkan method
            if (method === 'check') {
                // Jika method adalah 'check'
                saldoAkhir = saldoExchanger + saldoAllChain;  // Saldo akhir adalah saldo exchanger + saldo chain
                pnl = saldoAkhir-modalAwal;  // PNL adalah modal awal dikurangi saldo akhir
            }else if (method==="load") {
                // Jika method adalah 'check'
                saldoAkhir = saldoExchanger + saldoAllChain;  // Saldo akhir adalah saldo exchanger + saldo chain
                pnl = saldoAkhir - modalAwal;  // PNL adalah modal awal dikurangi saldo akhir
            }else if (method === 'reset' || method === 'start') {
                // Jika method adalah 'reset' atau 'start'
                saldoAkhir = saldoExchanger + saldoAllChain;  // Saldo akhir diset 0
                pnl = 0;  // PNL diset 0
            }
            
            // Tampilkan hasil modal awal, akhir, dan pnl setelah selesai
            $('#m_awal').text(Number(modalAwal).toFixed(2) + ' USDT');
            $('#m_akhir').text(saldoAkhir.toFixed(2) + ' USDT');
            $('#m_pnl').text(pnl.toFixed(2) + ' USDT');

            // Update PNL color
            const $pnlContainer = $('#pnl-container');
            $pnlContainer.removeClass('uk-text-success uk-text-danger uk-text-primary');
            if (pnl > 0) {
                $pnlContainer.addClass('uk-text-success');
            } else if (pnl < 0) {
                $pnlContainer.addClass('uk-text-danger');
            } else {
                $pnlContainer.addClass('uk-text-primary');
            }

            $('#lastUpdate').text(localStorage.getItem('MULTI_lastCheck'));
            USDTIDR(modalAwal).then((idrusdt) => {
                const idrModalAwal = parseFloat(idrusdt).toLocaleString("id-ID"); // Format Modal Awal ke IDR
                const usdtModalAwal = modalAwal.toFixed(2); // Format Modal Awal ke USDT

                // Kalkulasi IDR untuk saldo akhir dan PNL
                const idrSaldoAkhir = (saldoAkhir * idrusdt / modalAwal).toLocaleString("id-ID");
                const idrPNL = (pnl * idrusdt / modalAwal).toLocaleString("id-ID");
                
                // Tampilkan nilai Saldo Akhir
                $('#m_akhirs').text(`${saldoAkhir.toFixed(2)} $ (RP. ${idrSaldoAkhir})`);
                
                // Tampilkan nilai PNL
                $('#m_pnls').text(`${pnl.toFixed(2)} $ (RP. ${idrPNL})`);
            }).catch((error) => {
                console.log("-----------------------");
                console.log("Terjadi kesalahan saat konversi:", error);
            });


            // Debugging: Log data untuk memastikan semuanya benar
            console.log("-----------------------");
            console.log("Method: " + method);
            console.log("-----------------------");
            console.log("Saldo Exchanger: " + saldoExchanger);
            console.log("Saldo Chain: " + saldoAllChain);
            console.log("Saldo Awal: " + modalAwal);
            console.log("Saldo Akhir: " + saldoAkhir);
            console.log("PNL: " + pnl);
            console.log("-----------------------");

            // Update summary cards
            updateSummaryCards();
        }

        // Event handlers untuk paging PNL history
        $(document).on('click', '#pnlPrev', function() {
            if (pnlCurrentPage > 0) {
                pnlCurrentPage--;
                LoadTableHistory();
            }
        });
        $(document).on('click', '#pnlNext', function() {
            const history = JSON.parse(localStorage.getItem('MULTI_history')) || [];
            const totalPages = Math.max(1, Math.ceil(history.length / PNL_PAGE_SIZE));
            if (pnlCurrentPage < totalPages - 1) {
                pnlCurrentPage++;
                LoadTableHistory();
            }
        });

        $('#CheckModal').on('click', async function () {
            LoadTableHistory();

            // Show loading overlay for combined check
            window.BalanceCheckOverlay.show(
                'Cek Semua Saldo',
                'Mengambil data saldo dari wallet dan exchanger...'
            );
            window.BalanceCheckOverlay.updateProgress(5, 'Memulai proses pengecekan...');

            try {
                // Menunggu hingga kedua proses pengecekan selesai
                window.BalanceCheckOverlay.updateProgress(10, 'Memproses wallet chains...');

                await Promise.all([
                    new Promise((resolve) => {
                        $(document).one('WalletCheckCompleted', resolve);
                        $('#SaveWalletChains').trigger('click'); // Proses pengecekan wallet chains
                    }),
                    new Promise((resolve) => {
                        $(document).one('CEXCheckCompleted', resolve);
                        $('#SaveConfigCEXS').trigger('click'); // Proses pengecekan CEX
                    })
                ]);

                window.BalanceCheckOverlay.updateProgress(95, 'Menyimpan hasil...');

                // Menyimpan waktu saat data diperbarui
                var formattedTime = getFormattedTime();
                // Simpan waktu terakhir diperbarui ke localStorage
                localStorage.setItem('MULTI_lastCheck', formattedTime);

                ShowLabelModal("check");

                // Pastikan kedua tabel sudah siap sebelum menutup overlay
                await waitFor(() => isCexTableReady(), 15000, 100);
                await waitFor(() => isWalletTableReady(), 15000, 100);

                window.BalanceCheckOverlay.updateProgress(100, 'Memeriksa Ulang Data...');

                // Tutup overlay setelah semua siap
                setTimeout(() => {
                    window.BalanceCheckOverlay.hide();
                }, 200);
            } catch (error) {
                console.error('Error during check:', error);
                // Hide overlay on error
                setTimeout(() => {
                    window.BalanceCheckOverlay.hide();
                }, 500);
            }
        });

        // Fungsi untuk memuat data dari localStorage saat halaman di-refresh
        function 
        loadData() {
           // Memuat modal awal dari localStorage, jika tidak ada maka set default 0
            let modalAwal = parseFloat(localStorage.getItem('MULTI_MODALAWAL'));
            if (isNaN(modalAwal)) {
                modalAwal = 0;
                localStorage.setItem('MULTI_MODALAWAL', modalAwal.toFixed(2)); // Set nilai default jika tidak ditemukan
            }

            // Memuat saldo exchanger, jika tidak ada maka set default 0
            let saldoExchanger = parseFloat(localStorage.getItem('MULTI_TotalSaldoCEX'));
            if (isNaN(saldoExchanger)) {
                saldoExchanger = 0;
                localStorage.setItem('MULTI_TotalSaldoCEX', saldoExchanger); // Set nilai default jika tidak ditemukan
            }

            // Memuat asset data chain, jika tidak ada maka set default 0
            let assetDataChain = parseFloat(localStorage.getItem('MULTI_TotalSaldoChain'));
            if (isNaN(assetDataChain)) {
                assetDataChain = 0;
                localStorage.setItem('MULTI_TotalSaldoChain', assetDataChain); // Set nilai default jika tidak ditemukan
            }
            $("#MODALAWAL").val(Number(modalAwal).toFixed(2));
            // Mengonversi nilai USDT ke IDR dan menampilkannya
            USDTIDR(modalAwal).then((idrusdt) => {
                $("#RPMODAL").text("RP. " + parseFloat(idrusdt).toLocaleString("id-ID")); // Format ke format IDR
                console.log("-----------------------");
                console.log("Modal Awal USDT: " + modalAwal);
                console.log("Modal Awal USDT ke IDR: " + idrusdt);
            }).catch((error) => {
                console.log("-----------------------");
                console.log("Terjadi kesalahan saat konversi Modal Awal :", error);
            });

            // Mengatur status checkbox dan nilai input berdasarkan data di localStorage
            $('input[type="checkbox"]').each(function() {
                const checkbox = $(this);
                const id = checkbox.attr('id');

                // Ambil status checkbox dari localStorage, default unchecked jika tidak ada data
                const isChecked = localStorage.getItem(`MULTI_${id}`) === 'true';
                checkbox.prop('checked', isChecked);

                // Aktifkan atau nonaktifkan input sesuai dengan status checkbox
                const relatedInputs = checkbox.closest('.input-group').find('input[type="text"], input[type="number"]');
                relatedInputs.prop('disabled', !isChecked);

                // Set nilai input dari localStorage jika ada
                relatedInputs.each(function() {
                    const input = $(this);
                    const inputId = input.attr('id');
                    const savedValue = localStorage.getItem(`MULTI_${inputId}`);
                    if (savedValue !== null) {
                        input.val(savedValue);
                    }
                });

                // Menampilkan atau menyembunyikan baris tabel sesuai dengan status checkbox
                const tableRow = $(`#assetTableCexs tr:contains(${id})`);
                if (isChecked) {
                    tableRow.show(); // Tampilkan baris jika checkbox dicentang
                    restoreExchangeRow(id);
                } else {
                    tableRow.hide(); // Sembunyikan baris jika checkbox tidak dicentang
                    localStorage.removeItem(`MULTI_${id}_DETAIL`);
                    $(`#${id}Saldo`).text("0 {USDT}");
                }
            });

            const storedTotalCex = parseFloat(localStorage.getItem('MULTI_TotalSaldoCEX')) || 0;
            $('#TotalSaldoCEX').text(`${storedTotalCex.toFixed(2)} $`);

            // Memuat data hasil pengecekan aset wallet dari localStorage dan menampilkannya di tabel
            const assetData = JSON.parse(localStorage.getItem('MULTI_assetDataCEX')) || [];
            if (assetData.length > 0) {
                // Render data tabel
                $('#output_chain').html(
                    assetData.map(row => {
                        // Tentukan simbol token berdasarkan chain
                        const tokenSymbol = row.chain === 'base' ? 'USDC' : 'USDT';  // Base menggunakan USDC, lainnya menggunakan USDT
                        
                        return `
                            <tr>
                                <td><a href="${row.walletLink}" target="_blank">${row.chain.toUpperCase()}</a></td>
                                <td>${row.assetBalance} ${row.assetSymbol}</td>
                                <td>${row.gasBalance} ${row.gasSymbol} [${row.usdtGas}]</td>
                                <td>${row.total} USDT</td>
                            </tr>
                        `;
                    }).join('')
                );

                // Tampilkan tabel jika ada data
                $('#assetTableWallet').show();

                // Hitung total saldo USDT dari semua chain
                const totalUSDT = assetData.reduce((sum, data) => sum + parseFloat(data.total || 0), 0);
                $('#TotalSaldoWallets').text(totalUSDT.toFixed(2) + " $"); 

                // Menampilkan waktu terakhir diperbarui
                const lastUpdate = localStorage.getItem('MULTI_lastUpdateChain');
                if (lastUpdate) {
                    $('#updatechain').text(lastUpdate);
                }
            }
        
            // Memuat saldo excanger dari localStorage dan menampilkannya di tabel
            const exchanges = ['BINANCE', 'GATE', 'BITGET', 'KUCOIN', 'BYBIT','MEXC','INDODAX'];
                let totalSaldo = 0;

                exchanges.forEach(exchange => {
                    const saldoKey = `MULTI_${exchange}Saldo`;
                    const saldo = localStorage.getItem(saldoKey);
                    if (saldo) {
                        // Tampilkan saldo pada tabel jika ada data di localStorage
                        $(`#${exchange}Saldo`).text(`${parseFloat(saldo).toFixed(2)} USDT`);
                        getTotalSaldoCEXS();
                    }
                });

                LoadTableHistory()
                ShowLabelModal("load");
                updateSummaryCards();
        }
        //fungsi get balances chain EVM 

        async function getAssetBalancesEVM(rpcUrl, contractAddress, walletAddress, networkName, tokenRates) {
            try {

                const provider = new ethers.providers.JsonRpcProvider(rpcUrl);
                const erc20Abi = ["function balanceOf(address owner) view returns (uint256)"];
                const contract = new ethers.Contract(contractAddress, erc20Abi, provider);

                const balance = await contract.balanceOf(walletAddress);
            
                let decimals;
                let assetSymbol;
                if (networkName === 'bsc') {
                    decimals = 18;  
                    assetSymbol = 'USDT'; // BSC menggunakan USDT dengan desimal 18
                } else if (networkName === 'base') {
                    decimals = 6;   
                    assetSymbol = 'USDC'; // Base menggunakan USDC dengan desimal 6
                } else {
                    decimals = 6;   // Polygon, Arbitrum, Ethereum menggunakan 6 desimal
                    assetSymbol = 'USDT'; // Default menggunakan USDT
                }
                const formattedBalance = parseFloat(ethers.utils.formatUnits(balance, decimals)).toFixed(2);

                // Mendapatkan saldo gas
                const gasBalance = await provider.getBalance(walletAddress);
                let gasSymbol;
                let formattedGasBalance;

                if (networkName === 'bsc') {
                    gasSymbol = 'BNB';
                    formattedGasBalance = parseFloat(ethers.utils.formatEther(gasBalance)).toFixed(4) + '';
                } else if (networkName === 'polygon') {
                    gasSymbol = 'MATIC';
                    formattedGasBalance = parseFloat(ethers.utils.formatEther(gasBalance)).toFixed(4) + '';
                } else if (networkName === 'arbitrum') {
                    gasSymbol = 'ETH';
                    formattedGasBalance = parseFloat(ethers.utils.formatEther(gasBalance)).toFixed(4) + '';
                } else if (networkName === 'avax') {
                    gasSymbol = 'AVAX';
                    formattedGasBalance = parseFloat(ethers.utils.formatEther(gasBalance)).toFixed(4) + '';
                }else {
                    gasSymbol = 'ETH';
                    formattedGasBalance = parseFloat(ethers.utils.formatEther(gasBalance)).toFixed(4) + '';
                }
                
                const gasBalanceInUSD = (parseFloat(ethers.utils.formatEther(gasBalance)) * parseFloat(tokenRates[gasSymbol])).toFixed(2);
                
                let walletLink;
                switch (networkName) {
                    case 'ethereum':
                        walletLink = `https://etherscan.io/address/${walletAddress}`;
                        break;
                    case 'bsc':
                        walletLink = `https://bscscan.com/address/${walletAddress}`;
                        break;
                    case 'polygon':
                        walletLink = `https://polygonscan.com/address/${walletAddress}`;
                        break;
                    case 'base':
                        walletLink = `https://basescan.org/address/${walletAddress}`;
                        break;
                    case 'arbitrum':
                        walletLink = `https://arbiscan.io/address/${walletAddress}`;
                        break;
                    case 'avax':
                        walletLink = `https://snowtrace.io/address/${walletAddress}`;
                        break;
                    default:
                        walletLink = `https://explorer.${networkName}.com/address/${walletAddress}`;
                        break;
                }

                const totalBalanceInUSD = (parseFloat(formattedBalance) + parseFloat(gasBalanceInUSD)).toFixed(2);

                // Mengembalikan objek dengan data terstruktur
                return {
                    chain: networkName,
                    assetBalance: formattedBalance,     
                    assetSymbol,      
                    gasBalance: formattedGasBalance,
                    gasSymbol,
                    gasBalanceInUSD,
                    totalBalanceInUSD,
                    walletLink
                };
                
            } catch (error) {
                return { error: error.message }; // Menangani error
            }
        }
        //fungsi get balances chain SOLANA 
        async function getSolanaBalance(walletAddress, tokenRates) {
            try {
                const connection = new solanaWeb3.Connection("https://cors-anywhere.herokuapp.com/https://api.mainnet-beta.solana.com");  
                const publicKey = new solanaWeb3.PublicKey(walletAddress);

                // Mendapatkan saldo SOL
                const solBalance = await connection.getBalance(publicKey);
                const formattedSOL = (solBalance / solanaWeb3.LAMPORTS_PER_SOL).toFixed(4);  // saldo SOL yang diformat
                const gasBalanceInUSD = ((solBalance / solanaWeb3.LAMPORTS_PER_SOL) * tokenRates.SOL).toFixed(2); // saldo SOL dalam USD

                // Mendapatkan akun token USDT dengan alamat mint yang benar
                const usdtMintPublicKey = new solanaWeb3.PublicKey('Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB');  // Alamat mint yang benar
                const tokenAccounts = await connection.getParsedTokenAccountsByOwner(publicKey, { mint: usdtMintPublicKey });

                let formattedUSDT = '0';  // Default saldo USDT
                if (tokenAccounts.value.length > 0) {
                    const usdtAccountData = tokenAccounts.value[0]?.account?.data?.parsed;
                    if (usdtAccountData?.info?.tokenAmount?.uiAmount) {
                        const usdtBalance = usdtAccountData.info.tokenAmount.uiAmount;
                        formattedUSDT = usdtBalance.toFixed(2);  // Format saldo USDT
                    }
                }

                // Menjumlahkan nilai saldo dalam USD (gasBalanceInUSD dan formattedUSDT)
                const totalBalanceInUSD = (parseFloat(formattedUSDT) + parseFloat(gasBalanceInUSD)).toFixed(2);

                // Mengembalikan objek data terstruktur
                return {
                    chain: 'SOLANA',
                    assetBalance: formattedUSDT,
                    assetSymbol: 'USDT',
                    gasBalance: `${formattedSOL}`,
                    gasSymbol: 'SOL',
                    gasBalanceInUSD,
                    totalBalanceInUSD,
                    walletLink: `https://solscan.io/account/${walletAddress}`,
                };
                
            } catch (error) {
                console.log("-----------------------");
                console.log("Error:", error);  // Log error untuk debugging
                return { error: error.message };  // Mengembalikan objek dengan pesan error
            }
        }
        //fungsi get Price Rate        
        async function fetchTokenRates() {
            try {
                // Melakukan fetch data dari API
                const response = await fetch("https://data-api.binance.vision/api/v3/ticker/price?symbols=[%22BTCUSDT%22,%22ETHUSDT%22,%22BNBUSDT%22,%22POLUSDT%22,%22AVAXUSDT%22,%22SOLUSDT%22]");
                
                // Mengecek apakah respons valid
                if (!response.ok) {
                    throw new Error('Failed to fetch token rates');
                }
                
                // Parsing JSON data
                const data = await response.json();

                // Memastikan semua rates ditemukan dan terkonversi menjadi angka
                const rates = {
                    BTC: parseFloat(data.find(item => item.symbol === 'BTCUSDT')?.price) || 0,
                    ETH: parseFloat(data.find(item => item.symbol === 'ETHUSDT')?.price) || 0,
                    BNB: parseFloat(data.find(item => item.symbol === 'BNBUSDT')?.price) || 0,
                    MATIC: parseFloat(data.find(item => item.symbol === 'POLUSDT')?.price) || 0,
                    AVAX: parseFloat(data.find(item => item.symbol === 'AVAXUSDT')?.price) || 0,
                    SOL: parseFloat(data.find(item => item.symbol === 'SOLUSDT')?.price) || 0
                };

                return rates;
            } catch (error) {
                console.log("-----------------------");
                console.error('Error fetching token rates:', error);
                return {
                    BTC: 0,
                    ETH: 0,
                    BNB: 0,
                    MATIC: 0,
                    SOL: 0
                };  // Mengembalikan rates default 0 jika terjadi error
            }
        }  
        // Fungsi konversi USDT ke IDR
        async function USDTIDR(usdt) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: "https://cors-proxy-rosy.vercel.app/api/proxy?url=https://indodax.com/api/ticker/usdtidr", // Endpoint Indodax untuk USDT ke IDR
                    success: function (response) {
                        // Mendapatkan harga terkini dari Indodax API
                        var USDTRate = parseFloat(response.ticker.last);
                        localStorage.setItem('MULTI_USDTRate', USDTRate); // Menyimpan harga terkini ke localStorage
                        console.log("-----------------------");
                        console.log("Latest Rate Price USDTRate:", USDTRate);

                        // Konversi dari USDT ke IDR
                        var idrusdt = usdt * USDTRate;
                        console.log("USDT TO IDR : " + idrusdt);

                        resolve(idrusdt); // Mengembalikan nilai IDR
                    },
                    error: function (xhr, status, error) {
                        console.log("-----------------------");
                        console.log("Error get Price Rate USDTRate:", error);
                        reject(error); // Menangani error jika API gagal
                    }
                });
            });
        }

        //fungsi refresh
        $("#reload").on("click", function () {
            // Panggil fungsi reloadPage saat tombol ditekan
            location.reload();
        });
        //get time update
        function getFormattedTime() {
            const now = new Date();
            
            // Mendapatkan waktu dalam format HH:mm:ss dengan mengganti separator
            let time = now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: false
            });
            
            // Mengganti separator titik (.) dengan titik dua (:)
            time = time.replace(/\./g, ':');
            
            // Mendapatkan tanggal dalam format dd MMM yy
            const date = now.toLocaleDateString('id-ID', { 
                day: '2-digit', 
                month: 'short', 
                year: '2-digit' 
            }).replace(/\./g, ''); // Menghapus titik pada singkatan bulan

            // Menggabungkan waktu dan tanggal
            const formattedTime = `${date}-${time}`;
            
            // Ganti singkatan bulan agar konsisten
            const monthMap = { 'Agu': 'Ags', 'Okt': 'Okt', 'Des': 'Des' };
            Object.keys(monthMap).forEach(key => {
                if (formattedTime.includes(key)) {
                    // Tidak perlu replace, karena formatnya sudah benar
                }
            });
            return formattedTime;
        }

        // ============================================
        // FILTER PENCARIAN PNL HARIAN
        // ============================================

        // Handle button click to show search modal
        $('#SearchHistoryPNL').on('click', function(event) {
            event.preventDefault();

            // Set default date range (last 7 days)
            const today = new Date();
            const lastWeek = new Date(today);
            lastWeek.setDate(today.getDate() - 7);

            $('#endDate').val(today.toISOString().split('T')[0]);
            $('#startDate').val(lastWeek.toISOString().split('T')[0]);

            // Hide results container
            $('[id=rekapPNLContainer]').hide();

            // Show modal
            UIkit.modal('#search-pnl-modal').show();
        });

        // Apply filter and generate recap
        $('#applyFilterPNL').on('click', function() {
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();

            if (!startDate || !endDate) {
                if (typeof toast !== 'undefined' && toast.error) {
                    toast.error('Harap pilih tanggal mulai dan tanggal akhir!');
                }
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                if (typeof toast !== 'undefined' && toast.error) {
                    toast.error('Tanggal mulai tidak boleh lebih besar dari tanggal akhir!');
                }
                return;
            }

            // Generate recap
            generatePNLRecap(startDate, endDate);
        });

        // Reset filter
        $('#resetFilterPNL').on('click', function() {
            $('#startDate').val('');
            $('#endDate').val('');
            $('[id=rekapPNLContainer]').hide();
        });

        // Function to generate PNL recap
        function generatePNLRecap(startDate, endDate) {
            try {
                // Get PNL history from localStorage (use existing key MULTI_history)
                // Expected fields per entry: { date, saldoAwal, saldoAkhir, pnl, action }
                const historyData = JSON.parse(localStorage.getItem('MULTI_history') || '[]');

                console.log('=== DEBUG REKAP PNL ===');
                console.log('Total data history:', historyData.length);
                console.log('Start Date:', startDate);
                console.log('End Date:', endDate);

                if (!historyData || historyData.length === 0) {
                    if (typeof toast !== 'undefined' && toast.warning) {
                        toast.warning('Belum ada data history PNL!');
                    }
                    return;
                }

                // Convert dates to timestamp for comparison
                const startTimestamp = new Date(startDate).setHours(0, 0, 0, 0);
                const endTimestamp = new Date(endDate).setHours(23, 59, 59, 999);

                console.log('Start Timestamp:', new Date(startTimestamp));
                console.log('End Timestamp:', new Date(endTimestamp));

                // Filter data by date range
                const filteredData = historyData.filter(item => {
                    // Parse timestamp from item.date (format: "DD MMM YY-HH:MM:SS")
                    const rawTs = (item.date || '').toString();
                    const dateStr = rawTs.split('-')[0].trim(); // Get "DD MMM YY"
                    const parts = dateStr.split(' ').filter(p => p.trim() !== '');

                    if (parts.length < 3) {
                        console.warn('Invalid date format:', rawTs);
                        return false;
                    }

                    const day = parts[0];
                    const monthStr = parts[1];
                    const year = parts[2];

                    // Convert month abbreviation to number (support both Indonesian and English)
                    const monthMap = {
                        'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                        'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11,
                        'Mei': 4, 'Agu': 7, 'Okt': 9, 'Des': 11
                    };

                    const monthIndex = monthMap[monthStr];
                    if (monthIndex === undefined) {
                        console.warn('Unknown month:', monthStr, 'in timestamp:', rawTs);
                        return false;
                    }

                    const itemDate = new Date(2000 + parseInt(year), monthIndex, parseInt(day));
                    const itemTimestamp = itemDate.getTime();

                    const isInRange = itemTimestamp >= startTimestamp && itemTimestamp <= endTimestamp;

                    // Debug first few items
                    if (historyData.indexOf(item) < 3) {
                        console.log('Item:', rawTs, '| Parsed:', itemDate, '| In Range:', isInRange);
                    }

                    return isInRange;
                });

                console.log('Filtered data count:', filteredData.length);

                if (filteredData.length === 0) {
                    if (typeof toast !== 'undefined' && toast.warning) {
                        toast.warning('Tidak ada data dalam rentang tanggal yang dipilih!');
                    }
                    $('[id=rekapPNLContainer]').hide();
                    return;
                }

                // Group data by date
                const dailyRecap = {};
                filteredData.forEach(item => {
                    const rawTs = (item.date || '').toString();
                    const dateStr = rawTs.split('-')[0].trim(); // "DD MMM YY"
                    if (!dailyRecap[dateStr]) dailyRecap[dateStr] = [];
                    dailyRecap[dateStr].push(item);
                });

                console.log('Daily recap keys:', Object.keys(dailyRecap));
                console.log('Sample daily recap data:', dailyRecap[Object.keys(dailyRecap)[0]]);

                // Calculate daily summary for every date in the selected range (show all dates)
                const dailySummary = [];
                let totalModalAwal = 0;
                let totalModalAkhir = 0;
                let totalPNL = 0;

                const monthId = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
                const iter = new Date(startTimestamp);
                let debugCount = 0;
                while (iter.getTime() <= endTimestamp) {
                    // Format date key consistently: "DD MMM YY"
                    const day = String(iter.getDate()).padStart(2, '0');
                    const month = monthId[iter.getMonth()];
                    const year = String(iter.getFullYear()).slice(-2);
                    const dateKey = `${day} ${month} ${year}`;

                    const entries = dailyRecap[dateKey] || [];

                    // Debug first 3 iterations
                    if (debugCount < 3) {
                        console.log(`Iteration ${debugCount}: Looking for key "${dateKey}", found ${entries.length} entries`);
                        debugCount++;
                    }

                    let modalAwal = 0, modalAkhir = 0, pnl = 0, percentChange = 0;
                    if (entries.length) {
                        entries.sort((a,b) => {
                            const ta = (a.date || '').toString().split('-')[1] || '';
                            const tb = (b.date || '').toString().split('-')[1] || '';
                            return ta.localeCompare(tb);
                        });
                        const firstEntry = entries[0];
                        const lastEntry = entries[entries.length - 1];
                        modalAwal = parseFloat(firstEntry.saldoAwal) || 0;
                        modalAkhir = parseFloat(lastEntry.saldoAkhir) || 0;
                        pnl = modalAkhir - modalAwal;
                        percentChange = modalAwal > 0 ? ((pnl / modalAwal) * 100) : 0;
                        totalModalAwal += modalAwal;
                        totalModalAkhir += modalAkhir;
                        totalPNL += pnl;
                    }
                    dailySummary.push({
                        date: dateKey,
                        modalAwal, modalAkhir, pnl, percentChange
                    });
                    iter.setDate(iter.getDate() + 1);
                }

                // Ringkasan card dihilangkan; hanya table + footer

                // Render table
                let tableHTML = '';
                dailySummary.forEach(day => {
                    const pnlClass = day.pnl >= 0 ? 'uk-text-success' : 'uk-text-danger';
                    const percentClass = day.percentChange >= 0 ? 'uk-text-success' : 'uk-text-danger';

                    tableHTML += `
                        <tr>
                            <td class="uk-text-bold">${day.date}</td>
                            <td class="uk-text-right">$${formatUsdtValue(day.modalAwal)}</td>
                            <td class="uk-text-right">$${formatUsdtValue(day.modalAkhir)}</td>
                            <td class="uk-text-right ${pnlClass}"><b>${day.pnl >= 0 ? '&uarr;' : '&darr;'} $${formatUsdtValue(Math.abs(day.pnl))}</b></td>
                            <td class="uk-text-right ${percentClass}"><b>${day.percentChange.toFixed(2)}%</b></td>
                        </tr>
                    `;
                });

                $('[id=rekapPNLTableBody]').html(tableHTML);

                // Update footer
                const avgModalAwal = dailySummary.length > 0 ? totalModalAwal / dailySummary.length : 0;
                const avgModalAkhir = dailySummary.length > 0 ? totalModalAkhir / dailySummary.length : 0;
                const totalPercentChange = avgModalAwal > 0 ? ((totalPNL / avgModalAwal) * 100) : 0;
                const footerPNLClass = totalPNL >= 0 ? 'uk-text-success' : 'uk-text-danger';
                const footerPercentClass = totalPercentChange >= 0 ? 'uk-text-success' : 'uk-text-danger';

                $('[id=footerModalAwal]').text('$' + formatUsdtValue(avgModalAwal));
                $('[id=footerModalAkhir]').text('$' + formatUsdtValue(avgModalAkhir));
                $('[id=footerPNL]').html(`<span class="${footerPNLClass}">$${formatUsdtValue(totalPNL)}</span>`);
                $('[id=footerPercentage]').html(`<span class="${footerPercentClass}">${totalPercentChange.toFixed(2)}%</span>`);

                // Show results
                $('[id=rekapPNLContainer]').slideDown();

                if (typeof toast !== 'undefined' && toast.success) {
                    toast.success(`Berhasil menampilkan ${dailySummary.length} hari data rekap PNL!`);
                }

            } catch (error) {
                console.error('Error generating PNL recap:', error);
                if (typeof toast !== 'undefined' && toast.error) {
                    toast.error('Terjadi kesalahan saat membuat rekap PNL!');
                }
            }
        }

        // Render awal riwayat PNL saat halaman dimuat
        LoadTableHistory();
    });

    
    </script>

    <script src="https://cdn.jsdelivr.net/npm/uikit@3.6.22/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.6.22/dist/js/uikit-icons.min.js"></script>

    </body>
    </html>
